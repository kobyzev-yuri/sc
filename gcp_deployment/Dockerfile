# –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π Python –æ–±—Ä–∞–∑
FROM python:3.9-slim

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
WORKDIR /app

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã)
RUN apt-get update && apt-get install -y \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
COPY requirements.txt .

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN pip install --no-cache-dir -r requirements.txt

# –ö–æ–ø–∏—Ä—É–µ–º –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç (–≤–∫–ª—é—á–∞—è credentials –∏–∑ .config/)
COPY . .

# –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (–µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç)
RUN mkdir -p experiments results/visualization
RUN mkdir -p .config/gdrive .config/gcs
RUN mkdir -p results/predictions results/inference

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –∏–∑ results/inference (2 —Ñ–∞–π–ª–∞, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
# COPY —Å–∫–æ–ø–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã
COPY results/inference/ results/inference/

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ credentials (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
RUN echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ credentials –≤ Docker –æ–±—Ä–∞–∑–µ:" && \
    echo "   CWD: $(pwd)" && \
    echo "   HOME: $HOME" && \
    echo "   –°–æ–¥–µ—Ä–∂–∏–º–æ–µ .config/:" && \
    ls -la .config/ 2>&1 || echo "   .config/ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" && \
    echo "   –°–æ–¥–µ—Ä–∂–∏–º–æ–µ .config/gdrive/:" && \
    ls -la .config/gdrive/ 2>&1 || echo "   .config/gdrive/ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" && \
    echo "   –°–æ–¥–µ—Ä–∂–∏–º–æ–µ .config/gcs/:" && \
    ls -la .config/gcs/ 2>&1 || echo "   .config/gcs/ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" && \
    if [ -f .config/gdrive/credentials.json ]; then echo "‚úÖ Google Drive credentials –Ω–∞–π–¥–µ–Ω—ã –≤ .config/gdrive/"; else echo "‚ö†Ô∏è Google Drive credentials –ù–ï –Ω–∞–π–¥–µ–Ω—ã –≤ .config/gdrive/"; fi && \
    if [ -f .config/gcs/service-account-key.json ]; then echo "‚úÖ GCS credentials –Ω–∞–π–¥–µ–Ω—ã –≤ .config/gcs/"; else echo "‚ö†Ô∏è GCS credentials –ù–ï –Ω–∞–π–¥–µ–Ω—ã –≤ .config/gcs/"; fi && \
    if [ -f "$HOME/.config/gdrive/credentials.json" ]; then echo "‚úÖ Google Drive credentials –Ω–∞–π–¥–µ–Ω—ã –≤ $HOME/.config/gdrive/"; else echo "‚ö†Ô∏è Google Drive credentials –ù–ï –Ω–∞–π–¥–µ–Ω—ã –≤ $HOME/.config/gdrive/"; fi

# –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç –¥–ª—è Streamlit
EXPOSE 8080

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è Streamlit
ENV STREAMLIT_SERVER_PORT=8080
ENV STREAMLIT_SERVER_ADDRESS=0.0.0.0
ENV STREAMLIT_SERVER_HEADLESS=true
ENV STREAMLIT_BROWSER_GATHER_USAGE_STATS=false

# –ó–∞–ø—É—Å–∫–∞–µ–º Streamlit –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
CMD ["streamlit", "run", "scale/dashboard.py", "--server.port=8080", "--server.address=0.0.0.0"]

