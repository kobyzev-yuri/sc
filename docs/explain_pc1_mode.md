# Объяснение проблемы с PC1_mode

## Проблема

Все образцы получают `PC1_mode="normal"`, даже те, которые должны быть классифицированы как moderate или pathology.

## Причина

### 1. Поиск мод через KDE

В методе `_find_modes_kde()` моды ищутся через поиск пиков в распределении плотности PC1. 

**Проблема**: Найдена только **одна мода** (normal), потому что:
- Параметры поиска пиков (`height`, `distance`) слишком строгие
- Распределение PC1 может не иметь четко выраженных пиков для разных типов патологий

### 2. Классификация мод

Моды классифицируются на основе сравнения с **медианой PC1**:
```python
if position < self.pc1_percentiles["median"]:
    label = "normal"
elif position > self.pc1_percentiles["median"]:
    label = "pathology"
```

**Проблема**: Если найдена только одна мода, она получает label "normal" (если ниже медианы) или "pathology" (если выше).

### 3. Присвоение меток образцам

В методе `transform_to_spectrum()` каждому образцу присваивается метка **ближайшей моды**:
```python
distances = np.abs(pc1_values[:, np.newaxis] - mode_positions)
nearest_mode_idx = np.argmin(distances, axis=1)
df_result["PC1_mode"] = [mode_labels[i] for i in nearest_mode_idx]
```

**Проблема**: Если найдена только одна мода, все образцы получают метку этой моды.

## Пример: 9_ibd_mod_6mod

- **PC1**: 0.0269
- **PC1_spectrum**: 0.2108 (на спектральной шкале 0-1)
- **PC1_mode**: normal (потому что ближайшая мода - normal)
- **Moderate_relative_count**: 0.0303 (указывает на moderate воспаление)

**Проблема**: Образец имеет признаки moderate воспаления, но классифицируется как normal, потому что:
1. Найдена только одна мода (normal)
2. Эта мода находится на PC1=-0.7405 (ближе к образцу, чем другие моды)

## Решение

### Вариант 1: Использовать спектральную шкалу для классификации

Классифицировать образцы на основе `PC1_spectrum`:
- 0.0-0.2: normal
- 0.2-0.5: mild  
- 0.5-0.8: moderate
- 0.8-1.0: severe

### Вариант 2: Использовать GMM компоненты

GMM автоматически находит несколько компонентов (состояний) в данных. Можно классифицировать образцы на основе принадлежности к GMM компонентам.

### Вариант 3: Улучшить поиск мод

Настроить параметры поиска пиков в KDE, чтобы находить больше мод:
- Уменьшить `height` (минимальная высота пика)
- Уменьшить `distance` (минимальное расстояние между пиками)

## Рекомендация

Использовать **комбинированный подход**:
1. Использовать GMM для определения основных состояний
2. Использовать спектральную шкалу для точной классификации
3. Учитывать признаки патологии (например, Moderate_relative_count) для корректировки






