# Объяснение overlap_ratio

## Что такое overlap_ratio?

`overlap_ratio` - это **степень перекрытия** между соседними патчами при скользящем окне.

### Как это работает

При обработке WSI изображение разбивается на патчи (окна) фиксированного размера, которые "скользят" по изображению с определенным шагом (stride).

**Формула шага:**
```
stride = window_size * (1 - overlap_ratio)
```

### Примеры

#### Пример 1: overlap_ratio = 0.5 (50% перекрытие)
- Размер окна: 1024 пикселя
- Шаг (stride): `1024 * (1 - 0.5) = 512` пикселей
- Каждое следующее окно перекрывает предыдущее на 50%

```
Окно 1: [0-------1024]
Окно 2:        [512-------1536]  ← перекрытие 512 пикселей (50%)
Окно 3:                 [1024-------2048]
```

#### Пример 2: overlap_ratio = 0.8 (80% перекрытие)
- Размер окна: 1024 пикселя
- Шаг (stride): `1024 * (1 - 0.8) = 204.8 ≈ 205` пикселей
- Каждое следующее окно перекрывает предыдущее на 80%

```
Окно 1: [0-------1024]
Окно 2:    [205-------1229]  ← перекрытие ~819 пикселей (80%)
Окно 3:        [410-------1434]
```

#### Пример 3: overlap_ratio = 0.1 (10% перекрытие)
- Размер окна: 1024 пикселя
- Шаг (stride): `1024 * (1 - 0.1) = 921.6 ≈ 922` пикселей
- Каждое следующее окно перекрывает предыдущее на 10%

```
Окно 1: [0-------1024]
Окно 2:              [922-------1946]  ← перекрытие ~102 пикселя (10%)
Окно 3:                           [1844-------2868]
```

## Влияние на производительность

### Больше overlap (0.8-0.9)
✅ **Плюсы:**
- Лучше покрытие границ объектов
- Меньше пропусков на границах патчей
- Более точные результаты

❌ **Минусы:**
- **Много больше патчей** для обработки
- **Медленнее** (в 4-5 раз при overlap 0.8 vs 0.5)
- **Больше памяти** для хранения патчей

### Меньше overlap (0.1-0.3)
✅ **Плюсы:**
- **Быстрее** обработка (меньше патчей)
- **Меньше памяти**
- Подходит для тестирования

❌ **Минусы:**
- Могут быть пропуски на границах
- Меньше точность для мелких объектов

## Текущие значения в коде

### По умолчанию
```python
# scale/predict.py
WSIPredictor(..., overlap_ratio=0.5)  # 50% перекрытие (по умолчанию)
```

### В продакшене (batch скрипты)
```python
# predict_subsections_batch.py
OVERLAP_RATIO = 0.8  # 80% перекрытие для лучшего качества
```

### В тестах (для ускорения)
```python
# test/test_predict_via_subsections.py
overlap_ratio=0.2  # 20% перекрытие для быстрого теста

# test/test_subsections_timing.py
overlap_ratio=0.1  # 10% перекрытие для экономии памяти
```

## Сравнение количества патчей

Для секции размером 13440×15872 пикселей с окном 1024×1024:

| overlap_ratio | stride | Патчей по X | Патчей по Y | Всего патчей | Относительное время |
|---------------|--------|-------------|-------------|--------------|-------------------|
| 0.1 (10%)     | 922    | ~15         | ~17         | ~255         | 1x (базовое)      |
| 0.2 (20%)     | 819    | ~16         | ~19         | ~304         | 1.2x              |
| 0.5 (50%)     | 512    | ~26         | ~31         | ~806         | 3.2x              |
| 0.8 (80%)     | 205    | ~66         | ~77         | ~5082        | 20x               |

## Рекомендации

### Для продакшена
```python
overlap_ratio=0.8  # Максимальное качество
```

### Для тестирования
```python
overlap_ratio=0.2  # Баланс между скоростью и качеством
```

### Для быстрого теста
```python
overlap_ratio=0.1  # Минимум для проверки работоспособности
```

## Важно!

⚠️ **Overlap не влияет на обработку подсекций** - он влияет только на то, как патчи скользят внутри каждой подсекции. Подсекции сами могут пересекаться, но это отдельная логика.

## В вашем случае

Из результатов теста видно:
- `predict_section` с `overlap_ratio=0.2`: **229.71 сек**
- Это нормально для теста, но для продакшена нужно использовать `0.8` для лучшего качества





