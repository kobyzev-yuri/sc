# Процесс работы с подсекциями

## Общая идея

**Сначала разбиваем секцию 0 на подсекции (кусочки), затем обрабатываем их отдельно для ускорения.**

## Пошаговый процесс

### ЭТАП 1: Разбиение секции на подсекции

```python
# Создаем WSI объект
wsi_obj = wsi.WSI(
    wsi_path,
    num_sections=6,  # Находим 6 секций
    num_subsections=None  # Автоматически (auto) или num_subsections=3 для указания количества
)

# Разбиваем секцию 0 на подсекции
subsection_bounds = wsi_obj.extract_subsection_bounds(section_index=0)
```

**Что происходит:**
1. Берется секция 0 (первая секция)
2. Внутри секции находятся отдельные кусочки ткани:
   - **Автоматически (num_subsections=None)**: Находятся все крупные кусочки ткани
   - **С указанием количества (num_subsections=N)**: Берется N самых больших кусочков
3. Каждый кусочек становится подсекцией (bounding box)

**ВАЖНО:**
- Подсекции **МОГУТ ПЕРЕСЕКАТЬСЯ** (bounding boxes могут пересекаться)
- Это **НОРМАЛЬНО**! Разделители помогают определить принадлежность предиктов,
  но сами bounding boxes подсекций могут пересекаться
- Метод `_split_overlapping_subsections` пытается разделить пересечения,
  но полного устранения пересечений может не быть

### ЭТАП 2: Обработка подсекций

```python
# Обрабатываем каждую подсекцию отдельно
for subsection_index in range(len(subsection_bounds)):
    # iter_subsection_bgr обрабатывает ТОЛЬКО границы этой подсекции
    # НЕ обрабатывает всю секцию!
    subsection_preds = _predict_subsection(section_index, subsection_index)
    all_predictions.extend(subsection_preds)
```

**Что происходит:**
1. Каждая подсекция обрабатывается **отдельно** (не вся секция целиком!)
2. `iter_subsection_bgr` использует только границы конкретной подсекции
3. Это ускоряет обработку, так как каждая подсекция меньше всей секции

**ВАЖНО:**
- В областях пересечения подсекций один участок ткани может быть обработан **несколько раз**
- Это приводит к **дубликатам предиктов**

### ЭТАП 3: Постпроцессинг с учетом пересечений

```python
# Применяем специальный постпроцессинг
filtered_preds = _postprocess_subsections(all_predictions, section_index)
```

**Что происходит:**
1. Используются **разделители** для определения принадлежности предиктов к подсекциям
2. Фильтруются **дубликаты** в областях пересечения подсекций
3. Применяется стандартный **NMS и merge** для окончательной очистки

## Визуализация процесса

```
┌─────────────────────────────────────────┐
│ ЭТАП 1: Разбиение секции 0              │
│                                         │
│  Секция 0                               │
│  ┌──────────┐  ┌──────────┐           │
│  │ Кусочек 1│  │ Кусочек 2│           │
│  │          │  │          │           │
│  └──────────┘  └──────────┘           │
│      ↓              ↓                  │
│  Подсекция 0-0  Подсекция 0-1          │
│  (пересекаются!)                       │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│ ЭТАП 2: Обработка подсекций             │
│                                         │
│  Подсекция 0-0 ──┐                      │
│  [обработана]    │                      │
│                  ├── Пересечение ──┐    │
│  Подсекция 0-1 ──┘                  │    │
│  [обработана]                        │    │
│                                      │    │
│  → Дубликаты в области пересечения   │    │
└──────────────────────────────────────┼────┘
                                       ↓
┌─────────────────────────────────────────┐
│ ЭТАП 3: Постпроцессинг                  │
│                                         │
│  1. Определение принадлежности          │
│     (через разделители)                 │
│  2. Фильтрация дубликатов               │
│  3. NMS и merge                         │
│                                         │
│  → Результат без дубликатов             │
└─────────────────────────────────────────┘
```

## Пример использования

```python
from scale import wsi, predict, model_config

# 1. Создаем WSI с автоматическим разбиением на подсекции
wsi_obj = wsi.WSI(
    wsi_path="./wsi/image.tiff",
    num_sections=6,  # Находим 6 секций
    num_subsections=None  # Автоматически находим подсекции в секции 0
)

# 2. Создаем предиктор
predictor = predict.WSIPredictor(
    wsi_obj,
    model_configs,
    postprocess_settings,
    overlap_ratio=0.8
)

# 3. Обрабатываем секцию 0 через подсекции
# Внутри происходит:
#   - Разбиение секции 0 на подсекции (с пересечениями)
#   - Обработка каждой подсекции отдельно
#   - Постпроцессинг с учетом пересечений
predictions = predictor.predict_section_via_subsections(section_index=0)
```

## Ключевые моменты

1. **Сначала разбиваем**: Применяем разбиение к секции 0 (или другой секции)
2. **Подсекции могут пересекаться**: Это нормально, разделители помогают
3. **Обрабатываем отдельно**: Каждая подсекция обрабатывается независимо
4. **Учитываем пересечения**: Постпроцессинг фильтрует дубликаты

## Преимущества

- ✅ **Ускорение**: Меньшие подсекции обрабатываются быстрее
- ✅ **Гибкость**: Можно использовать auto или указать количество
- ✅ **Точность**: Разделители обеспечивают правильную фильтрацию
- ✅ **Совместимость**: Результаты идентичны обычному методу








