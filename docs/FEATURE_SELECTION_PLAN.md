# План подбора оптимальных признаков для построения шкалы патологии

## Цель

Подобрать оптимальный набор признаков, который:
1. **Корректно разделяет** нормальные и патологические образцы
2. **Сохраняет биологическую интерпретацию** (положительная корреляция с патологией)
3. **Максимизирует объясненную дисперсию** PC1
4. **Стабилен** на разных наборах данных

---

## Проблема с текущим подходом

### Обнаруженные проблемы:
1. **Paneth клетки** имеют обратную корреляцию с патологией (больше в нормальных тканях)
2. **Некоторые признаки** могут быть избыточными или слабо информативными
3. **Отсутствие систематической валидации** набора признаков

### Последствия:
- Патологические образцы (ibd_mod) классифицируются как нормальные
- Шкала инвертируется или смещается
- Снижается точность классификации

---

## Этап 1: Анализ корреляций и направлений признаков

### 1.1 Анализ корреляций с патологией

**Цель:** Определить, какие признаки положительно/отрицательно коррелируют с патологией.

**Методы:**
1. Вычислить корреляции между признаками и известными патологическими образцами
2. Использовать метки образцов (если доступны) или PC1 из базового набора признаков
3. Визуализировать корреляционную матрицу

**Критерии отбора:**
- ✅ **Включить:** Признаки с положительной корреляцией с патологией (> 0.1)
- ⚠️ **Проверить:** Признаки с низкой корреляцией (-0.1 до 0.1)
- ❌ **Исключить:** Признаки с отрицательной корреляцией (< -0.1)

### 1.2 Анализ loadings в PC1

**Цель:** Определить вклад каждого признака в первую главную компоненту.

**Методы:**
1. Обучить PCA на полном наборе признаков
2. Извлечь loadings первой компоненты (PC1)
3. Проанализировать знаки и абсолютные значения loadings

**Критерии отбора:**
- ✅ **Включить:** Признаки с положительными loadings (увеличивают PC1 → патология)
- ⚠️ **Проверить:** Признаки с малыми loadings (|loading| < 0.05)
- ❌ **Исключить:** Признаки с отрицательными loadings (уменьшают PC1 → норма)

### 1.3 Биологическая валидация

**Цель:** Проверить соответствие признаков биологическим знаниям.

**Проверки:**
- Патологические признаки (Mild, Dysplasia, Moderate, Meta, Granulomas) должны коррелировать с патологией
- Нормальные клетки (Paneth, Enterocytes в норме) могут иметь обратную корреляцию
- Иммунные клетки (Plasma Cells, Neutrophils) обычно коррелируют с патологией

---

## Этап 2: Исключение избыточных признаков

### 2.1 Анализ мультиколлинеарности

**Цель:** Найти и исключить избыточные признаки.

**Методы:**
1. Вычислить корреляционную матрицу между признаками
2. Найти пары признаков с высокой корреляцией (> 0.95)
3. Исключить один из пары (оставить более информативный)

**Критерии:**
- Если два признака сильно коррелируют, оставить тот, у которого:
  - Больше loading в PC1
  - Лучше биологическая интерпретация
  - Меньше пропусков значений

### 2.2 Анализ важности признаков

**Цель:** Определить, какие признаки наиболее важны для разделения образцов.

**Методы:**
1. Использовать loadings PC1 как меру важности
2. Вычислить вклад каждого признака в объясненную дисперсию
3. Ранжировать признаки по важности

**Критерии:**
- Включить признаки с высоким вкладом (топ-80% по важности)
- Исключить признаки с очень низким вкладом (< 1% от максимального)

---

## Этап 3: Валидация набора признаков

### 3.1 Валидация на известных образцах

**Цель:** Проверить, что выбранный набор признаков корректно классифицирует известные образцы.

**Методы:**
1. Использовать образцы с известной патологией (ibd_mod, severe cases)
2. Проверить, что они классифицируются как патологические (PC1_mode != normal)
3. Проверить, что нормальные образцы классифицируются как normal

**Критерии успеха:**
- ✅ Все ibd_mod образцы классифицируются как mild/moderate/severe
- ✅ Нормальные образцы (wnl) классифицируются как normal/mild
- ✅ Тяжелые случаи (severe) имеют высокий PC1_spectrum (> 0.8)

### 3.2 Стабильность шкалы

**Цель:** Проверить стабильность шкалы при изменении набора данных.

**Методы:**
1. Обучить PCA на разных подмножествах данных (bootstrap)
2. Проверить стабильность loadings
3. Проверить стабильность классификации образцов

**Критерии:**
- Loadings должны быть стабильными (низкая вариация между запусками)
- Классификация образцов должна быть консистентной

---

## Этап 4: Оптимизация и финализация

### 4.1 Перебор комбинаций признаков

**Цель:** Найти оптимальную комбинацию признаков.

**Методы:**
1. Систематический перебор комбинаций признаков (forward/backward selection)
2. Оценка качества каждой комбинации по метрикам:
   - Объясненная дисперсия PC1
   - Точность классификации известных образцов
   - Стабильность loadings

**Критерии выбора:**
- Максимальная объясненная дисперсия PC1
- Корректная классификация всех известных образцов
- Минимальное количество признаков (принцип бритвы Оккама)

### 4.2 Финальная валидация

**Цель:** Убедиться, что финальный набор признаков оптимален.

**Проверки:**
1. Все признаки имеют положительные loadings
2. Все признаки коррелируют с патологией
3. Нет избыточных признаков
4. Классификация корректна на всех образцах
5. Биологическая интерпретация понятна

---

## Рекомендуемый процесс

### Шаг 1: Базовый анализ (автоматизированный)
```bash
python test/analyze_feature_selection.py --mode correlation
python test/analyze_feature_selection.py --mode loadings
python test/analyze_feature_selection.py --mode validation
```

### Шаг 2: Ручная проверка результатов
- Просмотреть отчеты анализа
- Проверить биологическую интерпретацию
- Исключить проблемные признаки

### Шаг 3: Оптимизация набора признаков
```bash
python test/optimize_feature_selection.py --method forward
python test/optimize_feature_selection.py --method backward
```

### Шаг 4: Финальная валидация
```bash
python test/validate_feature_selection.py --final-set
```

---

## Рекомендуемый базовый набор признаков

### Патологические признаки (включить):
- ✅ **Mild** - легкая патология
- ✅ **Dysplasia** - дисплазия
- ✅ **Moderate** - умеренная патология
- ✅ **Meta** - метаплазия
- ✅ **Granulomas** - гранулемы (патологический признак)
- ✅ **EoE** - эозинофильный эзофагит (патологический признак)

### Иммунные клетки (включить с осторожностью):
- ✅ **Plasma Cells** - обычно коррелируют с патологией
- ✅ **Neutrophils** - обычно коррелируют с патологией

### Нормальные клетки (исключить или проверить):
- ❌ **Paneth** - больше в нормальных тканях (обратная корреляция)
- ⚠️ **Enterocytes** - проверить корреляцию (может быть нормальным)

### Структурные элементы (исключить):
- ❌ **Surface epithelium** - структурный элемент
- ❌ **Muscularis mucosae** - структурный элемент
- ❌ **White space** - служебный класс

---

## Метрики качества набора признаков

### 1. Объясненная дисперсия PC1
- **Цель:** > 40% (чем больше, тем лучше)
- **Интерпретация:** PC1 должен объяснять значительную часть вариации

### 2. Точность классификации известных образцов
- **Цель:** 100% для ibd_mod (все должны быть патологическими)
- **Интерпретация:** Шкала должна корректно разделять патологические образцы

### 3. Стабильность loadings
- **Цель:** Коэффициент вариации < 0.2 для важных признаков
- **Интерпретация:** Loadings не должны сильно меняться при изменении данных

### 4. Биологическая интерпретация
- **Цель:** Все признаки имеют положительную корреляцию с патологией
- **Интерпретация:** Шкала должна соответствовать биологическим знаниям

---

## Автоматизация процесса

### Скрипты для автоматического анализа:

1. **`test/analyze_feature_selection.py`** - базовый анализ признаков
   - Корреляции с патологией
   - Loadings в PC1
   - Валидация на известных образцах

2. **`test/optimize_feature_selection.py`** - оптимизация набора признаков
   - Forward selection
   - Backward elimination
   - Перебор комбинаций

3. **`test/validate_feature_selection.py`** - финальная валидация
   - Проверка всех критериев
   - Генерация отчета
   - Сохранение оптимального набора

---

## Примеры проблемных признаков

### Paneth клетки
- **Проблема:** Отрицательная корреляция с патологией
- **Причина:** Больше в нормальных тканях кишечника
- **Решение:** Исключить из признаков для шкалы патологии

### Избыточные признаки
- **Проблема:** Высокая корреляция между признаками (например, count и area)
- **Причина:** Оба признака измеряют одно и то же явление
- **Решение:** Оставить один из пары (обычно более информативный)

### Слабо информативные признаки
- **Проблема:** Низкий loading в PC1 (< 0.05)
- **Причина:** Признак не вносит значимый вклад в разделение образцов
- **Решение:** Исключить для упрощения модели

---

## Рекомендации

1. **Начните с базового набора** патологических признаков (без Paneth)
2. **Проведите автоматический анализ** всех признаков
3. **Исключите проблемные признаки** (отрицательные loadings, обратные корреляции)
4. **Валидируйте на известных образцах** (ibd_mod должны быть патологическими)
5. **Оптимизируйте набор** для максимальной объясненной дисперсии
6. **Документируйте финальный набор** и обоснование выбора

---

## Следующие шаги

1. ✅ Создать скрипт для автоматического анализа признаков
2. ✅ Создать скрипт для оптимизации набора признаков
3. ✅ Создать скрипт для валидации финального набора
4. ⏳ Запустить анализ на текущих данных
5. ⏳ Определить оптимальный набор признаков
6. ⏳ Обновить `select_feature_columns()` с оптимальным набором








