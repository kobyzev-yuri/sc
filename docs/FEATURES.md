# Признаки: Абсолютные и Относительные

## Обзор

В системе анализа патологий используются два типа признаков:
- **Абсолютные признаки** - сырые значения count и area для каждого класса
- **Относительные признаки** - нормализованные значения относительно Crypts

## Абсолютные признаки

### Определение
Абсолютные признаки - это исходные количественные характеристики патологий без нормализации:
- `{class}_count` - количество объектов данного класса
- `{class}_area` - общая площадь объектов данного класса

### Количество признаков
- **22 признака** (11 классов × 2 типа признаков)
  - 10 классов патологий + 1 Crypts (нормализатор)

### Полный список классов для абсолютных признаков

**Включенные классы (11 классов):**
1. **Crypts** - используется как нормализатор для относительных признаков
2. **Mild** - легкая патология
3. **Dysplasia** - дисплазия
4. **Moderate** - умеренная патология
5. **Meta** - метаплазия
6. **Plasma Cells** - плазматические клетки
7. **Neutrophils** - нейтрофилы
8. **EoE** - эозинофильный эзофагит (патологический признак)
9. **Enterocytes** - энтероциты
10. **Granulomas** - гранулемы (патологический признак)
11. **Paneth** - клетки Панета

**Исключенные классы:**
- **Surface epithelium** - поверхностный эпителий (структурный элемент, не используется как признак)
- **Muscularis mucosae** - мышечная оболочка слизистой (структурный элемент, не используется как признак)
- **White space** - белое пространство (служебный класс, не используется как признак)

**Формула расчета:**
```
Абсолютные признаки = 11 классов × 2 типа признаков = 22 признака
Где типы признаков: count, area
```

### Полный список абсолютных признаков (22 признака)

**Признаки по классам:**

1. **Crypts:**
   - `Crypts_count`
   - `Crypts_area`

2. **Mild:**
   - `Mild_count`
   - `Mild_area`

3. **Dysplasia:**
   - `Dysplasia_count`
   - `Dysplasia_area`

4. **Moderate:**
   - `Moderate_count`
   - `Moderate_area`

5. **Meta:**
   - `Meta_count`
   - `Meta_area`

6. **Plasma Cells:**
   - `Plasma Cells_count`
   - `Plasma Cells_area`

7. **Neutrophils:**
   - `Neutrophils_count`
   - `Neutrophils_area`

8. **EoE:**
   - `EoE_count`
   - `EoE_area`

9. **Enterocytes:**
   - `Enterocytes_count`
   - `Enterocytes_area`

10. **Granulomas:**
    - `Granulomas_count`
    - `Granulomas_area`

11. **Paneth:**
    - `Paneth_count`
    - `Paneth_area`

### Формула
```
{class}_count = количество объектов класса
{class}_area = сумма площадей всех объектов класса
```

### Преимущества
- ✅ Сохраняют информацию о размере биоптата
- ✅ Важны, когда размер сам по себе значим
- ✅ Полезны для оценки общей тяжести патологии
- ✅ Могут лучше работать при большом разбросе размеров образцов

### Недостатки
- ❌ Зависят от размера биоптата
- ❌ Сложнее сравнивать образцы разного размера
- ❌ Могут маскировать паттерны из-за различий в размере

## Относительные признаки

### Определение
Относительные признаки - это нормализованные значения, которые показывают отношение патологий к количеству и площади крипт:

1. **`{class}_relative_count`** - относительное количество
   ```
   relative_count = {class}_count / Crypts_count
   ```
   Показывает, сколько объектов класса приходится на одну крипту.

2. **`{class}_relative_area`** - относительная площадь
   ```
   relative_area = {class}_area / Crypts_area
   ```
   Показывает, какая доля площади крипт занята объектами данного класса.

3. **`{class}_mean_relative_area`** - средняя относительная площадь на объект
   ```
   mean_relative_area = relative_area / count = (area / Crypts_area) / count
   ```
   Показывает средний размер одного объекта класса относительно размера крипты.

### Количество признаков
- **30 признаков** (10 классов × 3 типа признаков)

### Полный список классов для относительных признаков

**Включенные классы (10 классов):**
1. **Mild** - легкая патология
2. **Dysplasia** - дисплазия
3. **Moderate** - умеренная патология
4. **Meta** - метаплазия
5. **Plasma Cells** - плазматические клетки
6. **Neutrophils** - нейтрофилы
7. **EoE** - эозинофильный эзофагит (патологический признак)
8. **Enterocytes** - энтероциты
9. **Granulomas** - гранулемы (патологический признак)
10. **Paneth** - клетки Панета

**Исключенные классы:**
- **Crypts** - используется как нормализатор, не включается в признаки
- **Surface epithelium** - поверхностный эпителий (структурный элемент, не используется как признак патологии)
- **Muscularis mucosae** - мышечная оболочка слизистой (структурный элемент, не используется как признак патологии)
- **White space** - белое пространство (служебный класс, не используется как признак патологии)

**Формула расчета:**
```
Относительные признаки = 10 классов × 3 типа признаков = 30 признаков
Где типы признаков: relative_count, relative_area, mean_relative_area
```

### Полный список относительных признаков (30 признаков)

**Признаки по классам:**

1. **Mild:**
   - `Mild_relative_count`
   - `Mild_relative_area`
   - `Mild_mean_relative_area`

2. **Dysplasia:**
   - `Dysplasia_relative_count`
   - `Dysplasia_relative_area`
   - `Dysplasia_mean_relative_area`

3. **Moderate:**
   - `Moderate_relative_count`
   - `Moderate_relative_area`
   - `Moderate_mean_relative_area`

4. **Meta:**
   - `Meta_relative_count`
   - `Meta_relative_area`
   - `Meta_mean_relative_area`

5. **Plasma Cells:**
   - `Plasma Cells_relative_count`
   - `Plasma Cells_relative_area`
   - `Plasma Cells_mean_relative_area`

6. **Neutrophils:**
   - `Neutrophils_relative_count`
   - `Neutrophils_relative_area`
   - `Neutrophils_mean_relative_area`

7. **EoE:**
   - `EoE_relative_count`
   - `EoE_relative_area`
   - `EoE_mean_relative_area`

8. **Enterocytes:**
   - `Enterocytes_relative_count`
   - `Enterocytes_relative_area`
   - `Enterocytes_mean_relative_area`

9. **Granulomas:**
   - `Granulomas_relative_count`
   - `Granulomas_relative_area`
   - `Granulomas_mean_relative_area`

10. **Paneth:**
    - `Paneth_relative_count`
    - `Paneth_relative_area`
    - `Paneth_mean_relative_area`

### Формулы

#### Relative Count
```
Mild_relative_count = Mild_count / Crypts_count
```
**Пример:**
- Если `Mild_count = 10`, `Crypts_count = 100`
- То `Mild_relative_count = 10 / 100 = 0.1`
- Это означает, что на каждую крипту приходится 0.1 объекта Mild (или 1 объект на 10 крипт)

#### Relative Area
```
Dysplasia_relative_area = Dysplasia_area / Crypts_area
```
**Пример:**
- Если `Dysplasia_area = 1000`, `Crypts_area = 10000`
- То `Dysplasia_relative_area = 1000 / 10000 = 0.1`
- Это означает, что дисплазия занимает 10% площади крипт

#### Mean Relative Area
```
Dysplasia_mean_relative_area = Dysplasia_relative_area / Dysplasia_count
                              = (Dysplasia_area / Crypts_area) / Dysplasia_count
```
**Пример:**
- Если `Dysplasia_area = 1000`, `Dysplasia_count = 10`, `Crypts_area = 10000`
- То `Dysplasia_relative_area = 0.1`
- И `Dysplasia_mean_relative_area = 0.1 / 10 = 0.01`
- Это означает, что средний размер одной дисплазии составляет 1% от размера крипты

### Преимущества
- ✅ Устраняют влияние размера биоптата
- ✅ Позволяют сравнивать образцы разного размера
- ✅ Фокус на плотности/интенсивности патологии
- ✅ Хорошо для выявления паттернов независимо от размера
- ✅ Более информативны (3 признака на класс вместо 2)

### Недостатки
- ❌ Требуют наличия Crypts для нормализации
- ❌ Могут терять информацию о размере, если размер важен

## Почему относительных признаков больше?

### Математическое объяснение

**Абсолютные признаки:**
- (10 классов патологий + 1 Crypts) × 2 типа признаков (count + area) = **22 признака**
- Исключены: Surface epithelium, Muscularis mucosae (структурные элементы)

**Относительные признаки:**
- 10 классов × 3 типа признаков (relative_count + relative_area + mean_relative_area) = **30 признаков**
- Исключены: Crypts (нормализатор), Surface epithelium, Muscularis mucosae (структурные элементы)

### Причины разницы

1. **Больше типов признаков**: 3 вместо 2
   - Добавлен `mean_relative_area` - средний размер объекта относительно крипты
   - Это дополнительная информация, которая помогает лучше характеризовать патологию

2. **Исключены классы из обоих типов признаков**:
   - **Surface epithelium** - исключен из абсолютных и относительных признаков (структурный элемент)
   - **Muscularis mucosae** - исключен из абсолютных и относительных признаков (структурный элемент)
   - **White space** - исключен из абсолютных и относительных признаков (служебный класс)
   - **Crypts** - включен в абсолютные признаки, но исключен из относительных (используется как нормализатор)

3. **Итоговый результат**: 10 × 3 = 30 > 11 × 2 = 22
   - Относительных признаков больше (30 vs 22), несмотря на меньшее число классов
   - Это происходит из-за дополнительного типа признака (`mean_relative_area`)

## Сравнительная таблица классов

| Класс | Абсолютные признаки | Относительные признаки | Примечание |
|-------|---------------------|------------------------|------------|
| **Crypts** | ✅ Включен | ❌ Исключен | Используется как нормализатор |
| **Mild** | ✅ Включен | ✅ Включен | Патологический признак |
| **Dysplasia** | ✅ Включен | ✅ Включен | Патологический признак |
| **Moderate** | ✅ Включен | ✅ Включен | Патологический признак |
| **Meta** | ✅ Включен | ✅ Включен | Метаплазия |
| **Plasma Cells** | ✅ Включен | ✅ Включен | Иммунные клетки |
| **Neutrophils** | ✅ Включен | ✅ Включен | Иммунные клетки |
| **EoE** | ✅ Включен | ✅ Включен | Патологический признак |
| **Enterocytes** | ✅ Включен | ✅ Включен | Клетки кишечника |
| **Granulomas** | ✅ Включен | ✅ Включен | Патологический признак |
| **Paneth** | ✅ Включен | ✅ Включен | Клетки Панета |
| **Surface epithelium** | ❌ Исключен | ❌ Исключен | Структурный элемент |
| **Muscularis mucosae** | ❌ Исключен | ❌ Исключен | Структурный элемент |
| **White space** | ❌ Исключен | ❌ Исключен | Служебный класс |

**Итого:**
- Абсолютные признаки: 11 классов × 2 = **22 признака**
- Относительные признаки: 10 классов × 3 = **30 признаков**

## Важные замечания

### Сумма относительных признаков НЕ равна 1

**Важно понимать:**
- Относительные признаки - это **независимые отношения** каждого класса к Crypts
- Сумма `relative_count` по всем классам **НЕ равна 1**
- Сумма `relative_area` по всем классам **НЕ равна 1**

**Пример:**
```
Mild_relative_count = 0.1
Dysplasia_relative_count = 0.05
Moderate_relative_count = 0.03
...
Сумма = 0.1 + 0.05 + 0.03 + ... ≠ 1
```

Это нормально, потому что каждый признак показывает отношение конкретного класса к Crypts, а не долю в общей сумме.

### Обработка нулевых значений

- Если `count = 0`, то `mean_relative_area = NaN` (избегаем деления на 0)
- Если `Crypts_count = 0` или `Crypts_area = 0`, относительные признаки не создаются

## Рекомендации по использованию

### Когда использовать относительные признаки (рекомендуется по умолчанию):
- ✅ Образцы разного размера
- ✅ Фокус на плотности патологии
- ✅ Выявление паттернов независимо от размера
- ✅ Большинство случаев анализа патологий

### Когда использовать абсолютные признаки:
- ✅ Размер биоптата сам по себе важен
- ✅ Оценка общей тяжести патологии
- ✅ Большой разброс размеров образцов
- ✅ Сравнение с клиническими данными, где размер имеет значение

### Сравнение методов
В веб-интерфейсе доступна функция "Сравнение методов", которая позволяет сравнить результаты анализа с относительными и абсолютными признаками и выбрать лучший подход.

## Технические детали

### Создание признаков

**Абсолютные признаки** создаются в `aggregate_predictions_from_dict()`:
```python
stats[f"{cls_name}_count"] = len(pred_list)
stats[f"{cls_name}_area"] = np.sum([p.polygon.area() for p in pred_list])
```

**Относительные признаки** создаются в `create_relative_features()`:
```python
# Исключаются: Crypts, Surface epithelium, Muscularis mucosae
excluded_classes = ["Crypts", "Surface epithelium", "Muscularis mucosae"]

# Для каждого класса создаются 3 признака:
# 1. relative_count = count / Crypts_count
# 2. relative_area = area / Crypts_area
# 3. mean_relative_area = relative_area / count
```

**Отбор признаков** выполняется в `select_feature_columns()`:
- Явно перечислены 10 классов для относительных признаков
- Исключены структурные элементы

## См. также

- [CLUSTER_SCORING.md](CLUSTER_SCORING.md) - методы маппинга кластеров на шкалу
- [CLASSIFICATION_CRITERIA.md](CLASSIFICATION_CRITERIA.md) - критерии классификации образцов
- [ANALYSIS.md](ANALYSIS.md) - анализ результатов и известные проблемы

