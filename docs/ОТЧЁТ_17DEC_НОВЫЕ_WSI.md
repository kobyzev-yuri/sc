## Сравнение шкалы до и после добавления новых WSI (17 декабря)

### Резюме

Добавление 9 новых WSI из `scale_results_17DEC/predictions` привело к **радикальному снижению метрик** (Score с 3.57 до 1.95, -45%). Основная причина: новые образцы имеют предсказания, которые не соответствуют их меткам классов (mod), большинство из них ближе к normal или промежуточные.

### 1. Данные и методика

**До:** 36 образцов (5 mod, 26 normal, 5 unknown/hp)  
**После:** 45 образцов (14 mod, 31 normal, 0 unknown)

**Новые образцы (9):**
- `10_gran_*` (5 образцов) — классифицированы как mod
- `14_lgd_ibd_*` (4 образца) — классифицированы как mod

### 1.1. Полный список WSI и их метки в экспериментах

| № | WSI | До новых WSI<br/>(merged) | После новых WSI<br/>(до ручной классификации) | После новых WSI<br/>(после ручной классификации) |
|---|-----|---------------------------|-----------------------------------------------|---------------------------------------------------|
| **Mod образцы (5 → 9 → 14)** |
| 1 | `9_ibd_mod_2mod` | mod | mod | mod |
| 2 | `9_ibd_mod_4mod` | mod | mod | mod |
| 3 | `9_ibd_mod_6mod` | mod | mod | mod |
| 4 | `9_ibd_mod_9mod` | mod | mod | mod |
| 5 | `19_ibd_mod_S024__20240822_083628` | mod | mod | mod |
| 6 | `14_lgd_ibd_S001a__20240808_083820` | — | mod | mod |
| 7 | `14_lgd_ibd_S002__20240808_084821` | — | mod | mod |
| 8 | `14_lgd_ibd_S004__20240808_085343` | — | mod | mod |
| 9 | `14_lgd_ibd_S010__20240809_092208` | — | mod | mod |
| 10 | `10_gran_2gran` | — | **unknown** | **mod** *(ручная метка)* |
| 11 | `10_gran_3gran` | — | **unknown** | **mod** *(ручная метка)* |
| 12 | `10_gran_4gran` | — | **unknown** | **mod** *(ручная метка)* |
| 13 | `10_gran_5gran` | — | **unknown** | **mod** *(ручная метка)* |
| 14 | `10_gran_6gran` | — | **unknown** | **mod** *(ручная метка)* |
| **Normal образцы (26 → 26 → 31)** |
| 15 | `35_wnl_colon_A-1-1__20220322_084346` | normal | normal | normal |
| 16 | `35_wnl_colon_A-1-1__20220323_091417` | normal | normal | normal |
| 17 | `35_wnl_colon_A-1-1__20220323_093611` | normal | normal | normal |
| 18 | `35_wnl_colon_A-1-1__20220323_121752` | normal | normal | normal |
| 19 | `35_wnl_colon_A-1-1__20220325_111048` | normal | normal | normal |
| 20 | `35_wnl_colon_A-1-1__20220325_123023` | normal | normal | normal |
| 21 | `35_wnl_colon_A-1-2__20220323_145822` | normal | normal | normal |
| 22 | `35_wnl_colon_A-1-3__20220323_150002` | normal | normal | normal |
| 23 | `35_wnl_colon_A-1-4__20220323_150143` | normal | normal | normal |
| 24 | `35_wnl_colon_A-1-5__20220322_084804` | normal | normal | normal |
| 25 | `35_wnl_colon_A-1-5__20220323_093804` | normal | normal | normal |
| 26 | `35_wnl_colon_A-1-5__20220323_121902` | normal | normal | normal |
| 27 | `35_wnl_colon_A-1-5__20220323_150318` | normal | normal | normal |
| 28 | `35_wnl_colon_A-1-5__20220325_111235` | normal | normal | normal |
| 29 | `35_wnl_colon_A-1-5__20220325_123213` | normal | normal | normal |
| 30 | `35_wnl_colon_A-1-6__20220323_150446` | normal | normal | normal |
| 31 | `35_wnl_colon_A-1-7__20220323_150631` | normal | normal | normal |
| 32 | `35_wnl_colon_B-1-1__20220322_084943` | normal | normal | normal |
| 33 | `35_wnl_colon_B-1-1__20220323_094041` | normal | normal | normal |
| 34 | `35_wnl_colon_B-1-1__20220325_111415` | normal | normal | normal |
| 35 | `35_wnl_colon_B-1-1__20220325_123429` | normal | normal | normal |
| 36 | `35_wnl_colon_B-1-5__20220322_085124` | normal | normal | normal |
| 37 | `35_wnl_colon_B-1-5__20220323_094222` | normal | normal | normal |
| 38 | `35_wnl_colon_B-1-5__20220325_111605` | normal | normal | normal |
| 39 | `35_wnl_colon_C-1-1__20220325_123707` | normal | normal | normal |
| 40 | `35_wnl_colon_C-1-5__20220325_123945` | normal | normal | normal |
| 41 | `17_hp_S008__20240820_084008` | **unknown** | **unknown** | **normal** *(ручная метка)* |
| 42 | `19_hp_S012__20240820_085057` | **unknown** | **unknown** | **normal** *(ручная метка)* |
| 43 | `19_hp_S013__20240820_085227` | **unknown** | **unknown** | **normal** *(ручная метка)* |
| 44 | `19_hp_S014__20240820_085512` | **unknown** | **unknown** | **normal** *(ручная метка)* |
| 45 | `19_hp_S015__20240820_085738` | **unknown** | **unknown** | **normal** *(ручная метка)* |

**Итого:**
- **До новых WSI:** 36 образцов (5 mod, 26 normal, 5 unknown)
- **После новых WSI (до ручной классификации):** 45 образцов (9 mod, 26 normal, 10 unknown)
- **После новых WSI (после ручной классификации):** 45 образцов (14 mod, 31 normal, 0 unknown)

**Примечания:**
- Образцы `10_gran_*` были автоматически классифицированы как `unknown` (нет ключевых слов 'mod' или 'ibd' в имени), затем вручную помечены как `mod`
- Образцы `14_lgd_ibd_*` были автоматически классифицированы как `mod` (содержат 'ibd' в имени)
- Образцы `17_hp_*` и `19_hp_*` были автоматически классифицированы как `unknown` (нет ключевых слов), затем вручную помечены как `normal`
- Ручные метки сохранены в `scale/cfg/manual_sample_labels.json`

**Методика:**
- Признаки: все относительные признаки всех патологий (39 признаков)
- Оценка: PCA (PC1, `random_state=42`)
- Метрики: `Score = 0.4·separation + 0.3·mean_pc1_norm_mod + 0.3·explained_variance`

### 2. Результаты экспериментов

#### 2.1. Лучший эксперимент ДО добавления новых WSI

**Эксперимент:** `feature_selection_all_methods_all_relative_full_rerun`  
**Метод:** `forward`  
**Признаков:** 28

**Метрики (без hp образцов):**
- Score: **3.5693**
- Separation: 8.0927
- Mod norm: 0.7324
- Explained variance: 0.3749

**Примечание:** Предыдущий эксперимент содержал 5 hp образцов как unknown, что завышало метрики. При правильной классификации (hp как normal) Score = 3.4753 (-0.0940).

#### 2.2. Лучший эксперимент ПОСЛЕ добавления новых WSI

**Эксперимент:** `feature_selection_all_methods_all_relative_corrected_20251220_155919`  
**Метод:** `backward`  
**Признаков:** 33

**Метрики:**
- Score: **1.8656**
- Separation: 4.1052
- Mod norm: 0.4740
- Explained variance: 0.2712

### 3. Сравнение результатов

| Метрика | До (36 образцов) | После (45 образцов) | Изменение |
|---------|------------------|---------------------|-----------|
| **Score** | 3.4753 | 1.8656 | **-1.6097 (-46.3%)** |
| **Separation** | 7.8577 | 4.1052 | -3.7525 (-47.8%) |
| **Mod norm** | 0.7324 | 0.4740 | -0.2584 (-35.3%) |
| **Explained variance** | 0.3749 | 0.2712 | -0.1037 (-27.7%) |
| **Признаков** | 28 | 33 | +5 |
| **Mod образцов** | 5 | 14 | +9 (+180%) |

### 4. Основные выводы

#### 4.1. Предыдущий эксперимент был некорректен

Эксперимент содержал 5 hp образцов как unknown, которые не участвовали в метриках разделения, но влияли на обучение PCA. Это завышало метрики:
- Без unknown: Score = 3.5693
- С hp как normal: Score = 3.4753 (-0.0940)

**Причина:** HP образцы имеют промежуточные характеристики (среднее PC1 = 0.13 между normal -1.33 и mod 6.77), что снижает separation при включении их как normal.

#### 4.2. Радикальное снижение метрик после добавления новых образцов

**Основная причина:** Новые образцы из `scale_results_17DEC` имеют предсказания, которые не соответствуют их меткам классов (mod).

**Оценка новых образцов на шкале merged модели:**

Референсные значения (merged модель, 31 образец: 5 mod, 26 normal):
- Mod: PC1 [2.38, 10.26], среднее = 6.53
- Normal: PC1 [-3.92, 0.94], среднее = -1.26
- Separation: 7.79

**Позиции новых образцов:**
- **Gran образцы (10_gran_*):** PC1 [0.55, 3.62], среднее = 1.96
  - Только 1 из 5 попадает в диапазон mod
  - 4 из 5 ближе к normal или промежуточные
- **IBD образцы (14_lgd_ibd_*):** PC1 [-1.74, 2.68], среднее = -0.04
  - Только 1 из 4 попадает в диапазон mod
  - 3 из 4 ближе к normal или промежуточные
  - `14_lgd_ibd_S001a` имеет PC1 = -1.74 (близко к normal, НЕ является воспалением)

**Классификация новых образцов:**
- Экстремальные воспаления (выше max mod): **0 образцов**
- В диапазоне mod (могут быть полезны): **3 образца** (`10_gran_2gran`, `14_lgd_ibd_S010`, `10_gran_4gran`)
- Промежуточные или близкие к normal: **6 образцов**

**Эксперимент с 3 "хорошими" воспалениями:**
Даже добавление только 3 образцов, попадающих в диапазон mod, ухудшает метрики:
- Базовые метрики: Score = 3.4562, Separation = 7.7913
- С 3 хорошими воспалениями: Score = 2.8502, Separation = 6.3621
- Снижение: Score -0.6060 (-17.5%), Separation -1.4292 (-18.4%)

**Причина:** Новые mod образцы имеют PC1 (2.19-3.22) ниже среднего старых mod образцов (6.23), что снижает среднее PC1 mod и уменьшает separation.

**Вывод:** Новые образцы не являются экстремальными воспалениями и не расширяют шкалу. Они "размывают" разделение между классами, что является основной причиной снижения метрик.

### 5. Проблема с hp образцами

**Характеристики hp образцов:**
- Среднее PC1 = 0.13 (между normal -1.33 и mod 6.77)
- Все 5 образцов ближе к normal, чем к mod
- При включении как normal снижают separation на -0.26 (-3.2%)

**Варианты решения:**

| Вариант | Score | Separation | Описание |
|---------|-------|------------|----------|
| 1. Без hp | 3.4562 | 7.7913 | Исключить hp образцы |
| 2. HP как normal | 3.4753 | 7.8577 | Текущий подход |
| 3. Промежуточная мода | **3.5693** | **8.0927** | HP участвуют в PCA, но не в метриках разделения |

**Рекомендация:** Вариант 3 (промежуточная мода) дает лучшие метрики и сохраняет разнообразие данных.

**Философия шкалы:**
Для количественного измерения степени воспаления необходимо использовать только экстремальные образцы. Промежуточные образцы (hp) должны либо исключаться, либо образовывать промежуточную моду. Включение промежуточных образцов как normal/0 размывает шкалу и лишает ее смысла количественного измерения.

### 6. Рекомендации

**Критические действия:**
1. ⚠️ **Проверить качество предсказаний** для новых образцов из `scale_results_17DEC` — возможно, модель не распознает патологии корректно
2. ⚠️ **Рассмотреть исключение новых образцов** из анализа, если они не соответствуют ожидаемым характеристикам класса
3. ⚠️ **Выбрать стратегию работы с hp образцами** из трех предложенных вариантов

**Дополнительные действия:**
- Провести анализ влияния изменения баланса классов на метрики
- Рассмотреть возможность стратификации или взвешивания образцов
- Проанализировать, не являются ли новые образцы выбросами
