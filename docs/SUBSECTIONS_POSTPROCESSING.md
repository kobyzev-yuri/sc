# Постпроцессинг для пересекающихся подсекций

## Проблема

При обработке секции через подсекции в областях пересечения подсекций могут появляться дубликаты предиктов. Стандартный постпроцессинг (NMS и merge) работает для перекрывающихся патчей, но не учитывает разделители между подсекциями.

## Решение

Добавлен специальный постпроцессинг `_postprocess_subsections`, который:

1. **Использует разделители** для определения принадлежности предиктов к подсекциям
2. **Фильтрует дубликаты** в областях пересечения на основе принадлежности к подсекциям
3. **Применяет стандартный постпроцессинг** (NMS и merge) после фильтрации

## Как это работает

### 1. Определение принадлежности к подсекциям

Для каждого предикта определяется, к какой подсекции он относится:
- Используется метод `get_subsection_for_prediction`, который учитывает разделители
- Если предикт находится в области пересечения, разделители помогают определить принадлежность
- Если разделители не помогли, используется ближайший центр подсекции

### 2. Фильтрация дубликатов в областях пересечения

Алгоритм фильтрации:
1. Для каждого предикта находятся все дубликаты (IoU > 0.3)
2. Если дубликаты относятся к разным подсекциям, которые пересекаются:
   - Это дубликаты из области пересечения
   - Оставляется только лучший предикт (по уверенности и размеру)
3. Если дубликаты в одной подсекции:
   - Стандартная обработка (будет обработано стандартным NMS/merge)

### 3. Стандартный постпроцессинг

После фильтрации применяется стандартный постпроцессинг:
- **NMS (Non-Maximum Suppression)**: Удаляет перекрывающиеся предикты с меньшей уверенностью
- **Merge по coverage**: Объединяет предикты с высоким перекрытием

## Использование

Метод `predict_section_via_subsections` автоматически использует специальный постпроцессинг:

```python
# Создаем WSI с подсекциями
wsi_obj = wsi.WSI(
    wsi_path,
    num_sections=6,
    num_subsections=None  # Автоматически
)

# Создаем предиктор
predictor = predict.WSIPredictor(
    wsi_obj,
    model_configs,
    postprocess_settings,
    overlap_ratio=0.8
)

# Обрабатываем секцию через подсекции
# Автоматически применяется специальный постпроцессинг
predictions = predictor.predict_section_via_subsections(section_index=0)
```

## Преимущества

1. **Точная фильтрация**: Использует разделители для точного определения принадлежности
2. **Устранение дубликатов**: Удаляет дубликаты в областях пересечения подсекций
3. **Совместимость**: Результаты идентичны обычному методу после фильтрации
4. **Автоматизация**: Не требует ручной настройки

## Алгоритм фильтрации

```
Для каждого предикта:
  1. Определить принадлежность к подсекции (через разделители)
  2. Найти все дубликаты (IoU > 0.3)
  3. Если дубликаты в разных пересекающихся подсекциях:
     - Оставить лучший (по conf и area)
  4. Иначе:
     - Оставить для стандартного NMS/merge
```

## Параметры

- **IoU threshold для дубликатов**: 0.3 (можно настроить в коде)
- **Критерий выбора лучшего предикта**: максимальная уверенность и площадь

## Ограничения

1. Требует наличия разделителей между подсекциями
2. Работает только для секций с несколькими подсекциями
3. Если подсекций нет или одна, используется стандартный постпроцессинг






