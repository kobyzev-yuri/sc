# Формирование шкалы на основе кластерного метода

## Обзор

Модуль `cluster_scoring.py` реализует **Вариант C** из Этапа 5 плана - маппинг кластеров на шкалу оценки патологии от 0 до 1.

## Подходы к маппингу кластеров на score

### 1. **На основе патологических признаков** (`pathology_features`) - Рекомендуется

**Принцип:** Кластеры с высокими средними значениями патологических признаков получают высокий score.

**Алгоритм:**
1. Вычисляются средние значения патологических признаков (Dysplasia, Mild, Moderate, EoE) для каждого кластера
2. Суммируются эти значения для каждого кластера
3. Нормализация суммы в диапазон [0, 1]

**Преимущества:**
- Прямая связь с патологическими маркерами
- Автоматический выбор признаков
- Интерпретируемость

**Пример:**
```python
from scale import clustering, cluster_scoring

# Кластеризация
clusterer = clustering.ClusterAnalyzer(method="hdbscan")
clusterer.fit(df_features)

# Маппинг на score
scorer = cluster_scoring.ClusterScorer(method="pathology_features")
df_with_scores = scorer.fit_transform(df_features, clusterer=clusterer)
```

### 2. **На основе PC1 центроидов** (`pc1_centroid`)

**Принцип:** Используется среднее значение PC1 (первая главная компонента) для каждого кластера.

**Алгоритм:**
1. Вычисляется среднее значение PC1 для каждого кластера
2. Нормализация PC1 значений в диапазон [0, 1]

**Преимущества:**
- Использует уже вычисленную PCA проекцию
- Быстрое вычисление
- Согласованность с PCA методом

**Недостатки:**
- Требует предварительного PCA анализа
- Менее интерпретируемо, чем патологические признаки

**Пример:**
```python
# Требуется предварительный PCA анализ
from scale import spectral_analysis

analyzer = spectral_analysis.SpectralAnalyzer()
analyzer.fit_pca(df_features)
df_pca = analyzer.transform_pca(df_features)

# Кластеризация на PCA данных
clusterer.fit(df_pca)

# Маппинг на основе PC1
scorer = cluster_scoring.ClusterScorer(method="pc1_centroid")
df_with_scores = scorer.fit_transform(df_pca, clusterer=clusterer)
```

### 3. **На основе экспертной разметки** (`expert_labels`)

**Принцип:** Патоморфолог размечает кластеры, присваивая каждому score от 0 до 1.

**Алгоритм:**
1. Эксперт просматривает репрезентативные образцы из каждого кластера
2. Присваивает каждому кластеру score (например: кластер 0 = 0.1, кластер 1 = 0.7, кластер 2 = 0.9)
3. Нормализация экспертных оценок в [0, 1]

**Преимущества:**
- Учитывает экспертное мнение
- Наиболее точный метод при наличии эксперта
- Можно использовать для калибровки других методов

**Недостатки:**
- Требует участия эксперта
- Трудоемко для большого числа кластеров

**Пример:**
```python
# Экспертная разметка
expert_labels = {
    0: 0.1,  # Норма
    1: 0.5,  # Легкая патология
    2: 0.8,  # Умеренная патология
    3: 0.95, # Тяжелая патология
}

scorer = cluster_scoring.ClusterScorer(method="expert_labels")
df_with_scores = scorer.fit_transform(
    df_features, 
    clusterer=clusterer,
    expert_labels=expert_labels
)
```

### 4. **На основе расстояния от нормального кластера** (`distance_from_normal`)

**Принцип:** Вычисляется расстояние каждого кластера от "нормального" кластера в пространстве признаков.

**Алгоритм:**
1. Автоматически определяется нормальный кластер (с минимальными патологическими признаками)
2. Вычисляется евклидово расстояние от нормального кластера до каждого кластера
3. Нормализация расстояний в [0, 1]

**Преимущества:**
- Автоматическое определение нормы
- Учитывает все признаки одновременно
- Хорошо работает при четком разделении норма/патология

**Недостатки:**
- Может быть чувствителен к масштабу признаков
- Требует нормализации признаков

**Пример:**
```python
scorer = cluster_scoring.ClusterScorer(method="distance_from_normal")
df_with_scores = scorer.fit_transform(
    df_features,
    clusterer=clusterer,
    normal_cluster=0  # Опционально: указать нормальный кластер вручную
)
```

## Рекомендации по выбору метода

### Для начала работы:
1. **`pathology_features`** - наиболее универсальный и интерпретируемый метод
2. Если есть PCA результаты - можно использовать **`pc1_centroid`**

### Для точной калибровки:
1. **`expert_labels`** - если есть доступ к патоморфологу
2. Использовать экспертные оценки для валидации других методов

### Для автоматизации:
1. **`distance_from_normal`** - если нужно полностью автоматическое определение

## Интеграция с кластеризацией

```python
from scale import clustering, cluster_scoring

# 1. Кластеризация
clusterer = clustering.ClusterAnalyzer(method="hdbscan")
clusterer.fit(df_features, use_pca=True, min_cluster_size=2)

# 2. Маппинг на score
scorer = cluster_scoring.ClusterScorer(method="pathology_features")
df_with_scores = scorer.fit_transform(df_features, clusterer=clusterer)

# Результат: DataFrame с колонками:
# - cluster: ID кластера
# - cluster_score: score от 0 до 1
```

## Интерпретация результатов

- **Score = 0.0 - 0.3**: Норма или легкая патология
- **Score = 0.3 - 0.7**: Умеренная патология
- **Score = 0.7 - 1.0**: Тяжелая патология

## Сравнение с другими методами

| Метод | Преимущества | Недостатки |
|-------|-------------|------------|
| **PCA Scoring** | Простой, быстрый | Зависит от первой компоненты |
| **Spectral Analysis** | Учитывает моды, устойчив к выбросам | Сложнее интерпретировать |
| **Cluster Scoring** | Учитывает структуру данных, интерпретируем | Требует кластеризации |

## Сохранение и загрузка

```python
# Сохранение
scorer.save("models/cluster_scorer.pkl")

# Загрузка
scorer = cluster_scoring.ClusterScorer.load("models/cluster_scorer.pkl")
```

