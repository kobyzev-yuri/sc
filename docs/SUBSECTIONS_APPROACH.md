# Подход обработки через подсекции

## Идея

**Обрабатываем НЕ всю секцию целиком, а ТОЛЬКО её подсекции (кусочки) отдельно.**

Подсекции могут пересекаться, поэтому нужен специальный постпроцессинг для устранения дубликатов.

## Сравнение подходов

### Обычный подход (`predict_section`)

```
Секция 0 (вся целиком)
├── Скользящее окно проходит по ВСЕЙ секции
├── Обрабатывается каждый патч
└── Результат: предикты для всей секции
```

**Проблема**: Обработка большой секции медленная.

### Подход через подсекции (`predict_section_via_subsections`)

```
Секция 0
├── Подсекция 0-0 (кусочек 1)
│   ├── Скользящее окно проходит ТОЛЬКО по подсекции 0-0
│   └── Результат: предикты для подсекции 0-0
│
├── Подсекция 0-1 (кусочек 2)
│   ├── Скользящее окно проходит ТОЛЬКО по подсекции 0-1
│   └── Результат: предикты для подсекции 0-1
│
├── Подсекция 0-2 (кусочек 3)
│   ├── Скользящее окно проходит ТОЛЬКО по подсекции 0-2
│   └── Результат: предикты для подсекции 0-2
│
└── Постпроцессинг:
    ├── Учитывает пересечения подсекций
    ├── Фильтрует дубликаты через разделители
    └── Результат: предикты для всей секции (без дубликатов)
```

**Преимущество**: Каждая подсекция меньше, обработка быстрее.

## Как это работает

### 1. Обработка подсекций

```python
# Для каждой подсекции отдельно
for subsection_index in range(len(subsection_bounds)):
    # iter_subsection_bgr обрабатывает ТОЛЬКО границы этой подсекции
    # НЕ обрабатывает всю секцию!
    subsection_preds = _predict_subsection(section_index, subsection_index)
    all_predictions.extend(subsection_preds)
```

**Ключевой момент**: `iter_subsection_bgr` использует только границы подсекции (`extract_subsection_bound`), а не всей секции.

### 2. Учет пересечений

Подсекции могут пересекаться:

```
Подсекция 0-0:  [████████░░░░]
Подсекция 0-1:  [░░░░████████]
Пересечение:    [░░░░████░░░░]  ← Эта область обработана дважды!
```

### 3. Фильтрация дубликатов

```python
# Для каждого предикта определяем принадлежность к подсекции
assigned_subsection = get_subsection_for_prediction(pred)

# Если два предикта перекрываются и относятся к разным
# пересекающимся подсекциям - это дубликат из области пересечения
if pred1.subsection != pred2.subsection and subsections_intersect:
    if pred1.iou_with(pred2) > 0.3:
        # Оставляем лучший (по conf и area)
        keep_best(pred1, pred2)
```

## Визуализация

### Обычный метод
```
┌─────────────────────────────────┐
│                                 │
│   Секция 0 (вся целиком)        │
│   ┌─────────────────────────┐   │
│   │ Скользящее окно         │   │
│   │ проходит по всей секции │   │
│   └─────────────────────────┘   │
│                                 │
└─────────────────────────────────┘
```

### Метод через подсекции
```
┌─────────────────────────────────┐
│   Секция 0                      │
│   ┌──────────┐  ┌──────────┐   │
│   │ Подсекция│  │ Подсекция│   │
│   │   0-0    │  │   0-1    │   │
│   │ ┌──────┐ │  │ ┌──────┐ │   │
│   │ │Окно  │ │  │ │Окно  │ │   │
│   │ │только│ │  │ │только│ │   │
│   │ │по 0-0│ │  │ │по 0-1│ │   │
│   │ └──────┘ │  │ └──────┘ │   │
│   └──────────┘  └──────────┘   │
│      ↑              ↑           │
│   Обработано    Обработано      │
│   отдельно      отдельно         │
│                                 │
│   Пересечение: ────┐            │
│                    │            │
│   Фильтрация дубликатов         │
└─────────────────────────────────┘
```

## Ключевые моменты

1. **Обрабатываем только подсекции**: `iter_subsection_bgr` использует `extract_subsection_bound`, а не `extract_biopsy_bound`
2. **Подсекции пересекаются**: Один участок может быть обработан в нескольких подсекциях
3. **Разделители помогают**: Используются для определения принадлежности предиктов к подсекциям
4. **Фильтрация дубликатов**: Удаляем дубликаты в областях пересечения

## Преимущества

- ✅ **Ускорение**: Меньшие подсекции обрабатываются быстрее
- ✅ **Параллелизация**: Подсекции можно обрабатывать параллельно
- ✅ **Точность**: Разделители обеспечивают правильную фильтрацию
- ✅ **Совместимость**: Результаты идентичны обычному методу



