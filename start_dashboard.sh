#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ dashboard —Å ngrok –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞

echo "üî¨ –ó–∞–ø—É—Å–∫ Dashboard –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–∞—Ç–æ–ª–æ–≥–∏–π WSI"
echo "=============================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "scale/dashboard.py" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª scale/dashboard.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "   –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ ngrok
if ! command -v ngrok &> /dev/null; then
    echo "‚ùå ngrok –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    echo "   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: sudo snap install ngrok"
    echo "   –ò–ª–∏: wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–æ—Ä—Ç 8501 —Å–≤–æ–±–æ–¥–µ–Ω
if lsof -Pi :8501 -sTCP:LISTEN -t >/dev/null ; then
    echo "‚ö†Ô∏è  –ü–æ—Ä—Ç 8501 —É–∂–µ –∑–∞–Ω—è—Ç"
    echo "   –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –ø–æ—Ä—Ç"
    read -p "   –£–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ –ø–æ—Ä—Ç—É 8501? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        kill -9 $(lsof -t -i:8501)
        sleep 2
    else
        exit 1
    fi
fi

echo "üì¶ –ó–∞–ø—É—Å–∫ Streamlit dashboard..."
streamlit run scale/dashboard.py --server.port 8501 --server.address 0.0.0.0 &
STREAMLIT_PID=$!

# –ñ–¥–µ–º, –ø–æ–∫–∞ Streamlit –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
sleep 3

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ Streamlit –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
if ! ps -p $STREAMLIT_PID > /dev/null; then
    echo "‚ùå –û—à–∏–±–∫–∞: Streamlit –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    exit 1
fi

echo "‚úÖ Streamlit –∑–∞–ø—É—â–µ–Ω (PID: $STREAMLIT_PID)"
echo ""
echo "üåê –ó–∞–ø—É—Å–∫ ngrok —Ç—É–Ω–Ω–µ–ª—è..."
echo ""

# –ó–∞–ø—É—Å–∫ ngrok –≤ —Ñ–æ–Ω–µ
ngrok http 8501 > /tmp/ngrok.log 2>&1 &
NGROK_PID=$!

sleep 3

# –ü–æ–ª—É—á–µ–Ω–∏–µ URL –∏–∑ ngrok
NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'https://[^"]*\.ngrok[^"]*' | head -1)

if [ -z "$NGROK_URL" ]; then
    echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å URL –æ—Ç ngrok"
    echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: tail -f /tmp/ngrok.log"
    echo ""
    echo "   –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å ngrok –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://localhost:4040"
else
    echo "‚úÖ ngrok –∑–∞–ø—É—â–µ–Ω (PID: $NGROK_PID)"
    echo ""
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo "üéâ Dashboard –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É:"
    echo ""
    echo "   $NGROK_URL"
    echo ""
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo ""
    echo "üìä Ngrok –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://localhost:4040"
    echo ""
fi

echo "üí° –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
cleanup() {
    echo ""
    echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
    kill $STREAMLIT_PID 2>/dev/null
    kill $NGROK_PID 2>/dev/null
    echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    exit 0
}

trap cleanup SIGINT SIGTERM

# –û–∂–∏–¥–∞–Ω–∏–µ
wait












