<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pathology Analysis API - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        
        input[type="text"], select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-top: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .progress-container {
            margin: 10px 0;
            background: #f0f0f0;
            border-radius: 8px;
            overflow: hidden;
            height: 24px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .progress-text {
            padding: 5px 10px;
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .results {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .results h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .results pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .feature-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .feature-tag {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .feature-tag:hover {
            background: #5568d3;
        }
        
        .feature-tag.selected {
            background: #764ba2;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #667eea;
            text-align: center;
        }
        
        .metric-card .label {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .metric-card .value {
            color: #333;
            font-size: 24px;
            font-weight: bold;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ Pathology Analysis API</h1>
        <p class="subtitle">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API –∞–Ω–∞–ª–∏–∑–∞ –ø–∞—Ç–æ–ª–æ–≥–∏–π</p>
        
        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö -->
        <div class="section">
            <h2>üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h2>
            <div class="form-group">
                <label>–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö:</label>
                <select id="dataSource">
                    <option value="directory">–õ–æ–∫–∞–ª—å–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è</option>
                    <option value="experiment">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞</option>
                    <option value="gdrive">Google Drive</option>
                    <option value="gcs">Google Cloud Storage</option>
                </select>
            </div>
            <div class="form-group" id="pathGroup">
                <label id="pathLabel">–ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:</label>
                <input type="text" id="dataPath" placeholder="results/predictions">
            </div>
            <div class="form-group hidden" id="experimentGroup">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç:</label>
                <select id="experimentSelect">
                    <option value="">-- –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ --</option>
                </select>
                <button onclick="loadExperimentsForSelection()" style="margin-top: 5px; padding: 5px 10px; font-size: 12px;">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            </div>
            <div class="form-group hidden" id="bucketGroup">
                <label>Bucket name:</label>
                <input type="text" id="bucketName" placeholder="scalebucket">
            </div>
            <div class="form-group hidden" id="prefixGroup">
                <label>Prefix (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                <input type="text" id="prefix" placeholder="">
            </div>
            <button onclick="loadData()" id="loadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
            <div id="loadStatus"></div>
            <div id="progressContainer" class="hidden" style="margin-top: 10px;">
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                <div class="progress-text" id="progressText">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
            </div>
        </div>
        
        <!-- –ê–≥—Ä–µ–≥–∞—Ü–∏—è -->
        <div class="section">
            <h2>üìä –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö</h2>
            <button onclick="aggregateData()" id="aggregateBtn" disabled>–ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å</button>
            <div id="aggregateStatus"></div>
            <div id="featuresList" class="hidden"></div>
        </div>
        
        <!-- –û—Ü–µ–Ω–∫–∞ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ -->
        <div class="section">
            <h2>üéØ –û—Ü–µ–Ω–∫–∞ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ (–∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Ç–µ–≥–∏ –≤—ã—à–µ)
            </p>
            <button onclick="evaluateFeatures()" id="evaluateBtn" disabled>–û—Ü–µ–Ω–∏—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–∏</button>
            <div id="evaluateStatus"></div>
            <div id="metricsResults" class="hidden"></div>
        </div>
        
        <!-- PCA Score -->
        <div class="section">
            <h2>üìà PCA Score</h2>
            <button onclick="calculatePCAScore()" id="pcaBtn" disabled>–í—ã—á–∏—Å–ª–∏—Ç—å PCA Score</button>
            <div id="pcaStatus"></div>
            <div id="pcaResults" class="hidden"></div>
        </div>
        
        <!-- –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã -->
        <div class="section">
            <h2>üß™ –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                –í—ã–±–µ—Ä–∏—Ç–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –≤ —Ä–∞–∑–¥–µ–ª–µ "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö" –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç—Ä–∏–∫, PCA –∏ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤.
            </p>
        </div>
        
        <!-- –°–ø–µ–∫—Ç—Ä–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ -->
        <div class="section">
            <h2>üåà –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–µ–∫—Ç—Ä–∞</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                –°–æ–∑–¥–∞–µ—Ç —Å–ø–µ–∫—Ç—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ PCA –¥–∞–Ω–Ω—ã—Ö. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –¥–ª—è PCA (–∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Ç–µ–≥–∏ –≤—ã—à–µ).
            </p>
            <div class="form-group">
                <label>–ù–∏–∂–Ω–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å:</label>
                <input type="number" id="percentileLow" value="1.0" step="0.1" min="0" max="50">
            </div>
            <div class="form-group">
                <label>–í–µ—Ä—Ö–Ω–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å:</label>
                <input type="number" id="percentileHigh" value="99.0" step="0.1" min="50" max="100">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="useGMM" style="width: auto; margin-right: 5px;">
                    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GMM –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é
                </label>
            </div>
            <button onclick="createSpectrum()" id="spectrumBtn" disabled>–°–æ–∑–¥–∞—Ç—å —Å–ø–µ–∫—Ç—Ä</button>
            <div id="spectrumStatus"></div>
            <div id="spectrumResults" class="hidden"></div>
        </div>
        
        <!-- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ -->
        <div class="section">
            <h2>üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç —Å–æ –≤—Å–µ–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ dashboard.
            </p>
            <div class="form-group">
                <label>–ò–º—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞:</label>
                <input type="text" id="experimentName" placeholder="experiment_20241124">
            </div>
            <button onclick="saveExperiment()" id="saveExperimentBtn" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç</button>
            <div id="saveExperimentStatus"></div>
        </div>
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div class="section">
            <h2>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
            <div id="results"></div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:8000';
        let currentCacheKey = null;
        let currentDfFeaturesCacheKey = null;
        let availableFeatures = [];
        let selectedFeatures = [];
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –ø—Ä–∏ —Å–º–µ–Ω–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        document.getElementById('dataSource').addEventListener('change', function() {
            const source = this.value;
            const pathGroup = document.getElementById('pathGroup');
            const experimentGroup = document.getElementById('experimentGroup');
            const bucketGroup = document.getElementById('bucketGroup');
            const prefixGroup = document.getElementById('prefixGroup');
            
            if (source === 'experiment') {
                pathGroup.classList.add('hidden');
                experimentGroup.classList.remove('hidden');
                bucketGroup.classList.add('hidden');
                prefixGroup.classList.add('hidden');
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —ç—Ç–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
                loadExperimentsForSelection();
            } else if (source === 'gcs') {
                pathGroup.classList.add('hidden');
                experimentGroup.classList.add('hidden');
                bucketGroup.classList.remove('hidden');
                prefixGroup.classList.remove('hidden');
            } else if (source === 'gdrive') {
                pathGroup.classList.remove('hidden');
                experimentGroup.classList.add('hidden');
                bucketGroup.classList.add('hidden');
                prefixGroup.classList.add('hidden');
                document.getElementById('pathLabel').textContent = 'Google Drive URL:';
            } else {
                pathGroup.classList.remove('hidden');
                experimentGroup.classList.add('hidden');
                bucketGroup.classList.add('hidden');
                prefixGroup.classList.add('hidden');
                document.getElementById('pathLabel').textContent = '–ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:';
            }
        });
        
        async function loadExperimentsForSelection() {
            const select = document.getElementById('experimentSelect');
            select.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/experiments?top_n=10`);
                const data = await response.json();
                
                if (response.ok && data.experiments && data.experiments.length > 0) {
                    select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç --</option>';
                    data.experiments.forEach(exp => {
                        const option = document.createElement('option');
                        option.value = exp.name;
                        option.textContent = `${exp.name} (Score: ${exp.score.toFixed(4)}, Features: ${exp.n_features})`;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤</option>';
                }
            } catch (error) {
                select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
            }
        }
        
        async function loadData() {
            const source = document.getElementById('dataSource').value;
            const path = document.getElementById('dataPath').value;
            const bucketName = document.getElementById('bucketName').value;
            const prefix = document.getElementById('prefix').value;
            const experimentName = document.getElementById('experimentSelect').value;
            const statusDiv = document.getElementById('loadStatus');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const btn = document.getElementById('loadBtn');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>–ó–∞–≥—Ä—É–∑–∫–∞...';
            statusDiv.innerHTML = '<div class="status loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –∏ Google –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
            const showProgress = (source === 'directory' || source === 'gdrive' || source === 'gcs');
            if (showProgress) {
                progressContainer.classList.remove('hidden');
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                progressText.textContent = '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...';
            } else {
                progressContainer.classList.add('hidden');
            }
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            const requestId = Date.now().toString();
            let progressInterval = null;
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–ø—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            if (showProgress) {
                let lastProgress = 0;
                progressInterval = setInterval(async () => {
                    try {
                        const progressResponse = await fetch(`${API_BASE}/api/v1/load-progress`);
                        const progressData = await progressResponse.json();
                        
                        if (progressData.status === 'loading') {
                            const progress = Math.round(progressData.progress * 100);
                            if (progress >= lastProgress) {
                                progressBar.style.width = `${progress}%`;
                                progressBar.textContent = `${progress}%`;
                                progressText.textContent = progressData.message || `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${progressData.current}/${progressData.total}`;
                                lastProgress = progress;
                            }
                        } else if (progressData.status === 'completed') {
                            clearInterval(progressInterval);
                            progressBar.style.width = '100%';
                            progressBar.textContent = '100%';
                            progressText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
                        }
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ–ø—Ä–æ—Å–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                    }
                }, 300); // –û–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞–∂–¥—ã–µ 300–º—Å
            }
            
            try {
                const requestBody = {
                    source: source,
                    path: (source === 'gcs' || source === 'experiment') ? null : path,
                    bucket_name: source === 'gcs' ? bucketName : null,
                    prefix: source === 'gcs' ? prefix : null,
                    experiment_name: source === 'experiment' ? experimentName : null,
                    experiments_dir: source === 'experiment' ? 'experiments' : null
                };
                
                if (source === 'experiment' && !experimentName) {
                    throw new Error('–í—ã–±–µ—Ä–∏—Ç–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞');
                }
                
                const response = await fetch(`${API_BASE}/api/v1/load-data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–ø—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                if (progressInterval) {
                    clearInterval(progressInterval);
                }
                
                const data = await response.json();
                
                if (response.ok) {
                    // –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                    if (showProgress) {
                        progressBar.style.width = '100%';
                        progressBar.textContent = '100%';
                        progressText.textContent = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.files_count || 0} —Ñ–∞–π–ª–æ–≤`;
                    }
                    
                    currentCacheKey = data.cache_key || data.df_features_cache_key;
                    
                    if (source === 'experiment') {
                        statusDiv.innerHTML = `<div class="status success">
                            ‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞: ${data.experiment_name}<br>
                            –û–±—Ä–∞–∑—Ü–æ–≤: ${data.files_count}<br>
                            ${data.has_features ? '‚úÖ –ï—Å—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–∏' : ''} ${data.has_aggregated ? '‚úÖ –ï—Å—Ç—å –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ' : ''}
                            ${data.has_pca ? '‚úÖ –ï—Å—Ç—å PCA –¥–∞–Ω–Ω—ã–µ' : ''} ${data.has_analyzer ? '‚úÖ –ï—Å—Ç—å analyzer' : ''}
                        </div>`;
                        
                        // –î–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω—ã
                        if (data.df_features_cache_key) {
                            currentDfFeaturesCacheKey = data.df_features_cache_key;
                            currentCacheKey = data.df_features_cache_key;
                            
                            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ (–ø—Ä–∏–∑–Ω–∞–∫–∏ –∏ –º–µ—Ç—Ä–∏–∫–∏)
                            if (data.experiment_config) {
                                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ—á–∞–µ–º –ø—Ä–∏–∑–Ω–∞–∫–∏ –∏–∑ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞
                                if (data.selected_features && data.selected_features.length > 0) {
                                    selectedFeatures = data.selected_features;
                                    
                                    // –û–±–Ω–æ–≤–ª—è–µ–º UI –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
                                    setTimeout(() => {
                                        // –û—Ç–º–µ—á–∞–µ–º –ø—Ä–∏–∑–Ω–∞–∫–∏ –≤ UI
                                        const featureTags = document.querySelectorAll('.feature-tag');
                                        featureTags.forEach(tag => {
                                            if (selectedFeatures.includes(tag.textContent)) {
                                                tag.classList.add('selected');
                                            }
                                        });
                                        
                                        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ PCA –∏ —Å–ø–µ–∫—Ç—Ä–∞, —Ç–∞–∫ –∫–∞–∫ –ø—Ä–∏–∑–Ω–∞–∫–∏ –≤—ã–±—Ä–∞–Ω—ã
                                        document.getElementById('evaluateBtn').disabled = false;
                                        document.getElementById('pcaBtn').disabled = false;
                                        document.getElementById('spectrumBtn').disabled = false;
                                        
                                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞
                                        if (data.metrics) {
                                            window.currentMetrics = data.metrics;
                                            
                                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞
                                            const metricsDiv = document.getElementById('metricsResults');
                                            if (metricsDiv) {
                                                metricsDiv.classList.remove('hidden');
                                                let html = `<h3>–ú–µ—Ç—Ä–∏–∫–∏ –∏–∑ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞:</h3>`;
                                                html += `<div class="metrics-grid">`;
                                                html += `<div class="metric-card"><div class="label">Score</div><div class="value">${data.metrics.score?.toFixed(4) || 'N/A'}</div></div>`;
                                                html += `<div class="metric-card"><div class="label">Separation</div><div class="value">${data.metrics.separation?.toFixed(4) || 'N/A'}</div></div>`;
                                                if (data.metrics.explained_variance) {
                                                    html += `<div class="metric-card"><div class="label">Explained Variance</div><div class="value">${(data.metrics.explained_variance * 100).toFixed(2)}%</div></div>`;
                                                }
                                                html += `</div>`;
                                                html += `<pre>${JSON.stringify(data.metrics, null, 2)}</pre>`;
                                                metricsDiv.innerHTML = html;
                                            }
                                        }
                                        
                                        // –ó–∞–≥—Ä—É–∂–∞–µ–º PCA –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
                                        if (data.has_pca && data.pca_cache_key) {
                                            console.log('‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ PCA –¥–∞–Ω–Ω—ã—Ö –∏–∑ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞:', data.pca_cache_key, '–æ–±—Ä–∞–∑—Ü–æ–≤:', data.pca_samples_count);
                                            // –ó–∞–≥—Ä—É–∂–∞–µ–º PCA –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞
                                            setTimeout(() => {
                                                loadPCADataFromCache(data.pca_cache_key);
                                                // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ PCA –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—á–∏—Å–ª—è–µ–º —Å–ø–µ–∫—Ç—Ä
                                                setTimeout(() => {
                                                    if (selectedFeatures.length > 0) {
                                                        console.log('üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å–ø–µ–∫—Ç—Ä–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ PCA');
                                                        createSpectrum();
                                                    }
                                                }, 1000);
                                            }, 500);
                                        } else {
                                            console.log('‚ö†Ô∏è PCA –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–µ, –≤—ã—á–∏—Å–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏');
                                            // –ï—Å–ª–∏ PCA –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –Ω–æ –µ—Å—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–∏ - –≤—ã—á–∏—Å–ª—è–µ–º PCA –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                                            if (selectedFeatures.length > 0) {
                                                setTimeout(() => {
                                                    console.log('üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ PCA –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞');
                                                    calculatePCAScore().then(() => {
                                                        // –ü–æ—Å–ª–µ PCA –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—á–∏—Å–ª—è–µ–º —Å–ø–µ–∫—Ç—Ä
                                                        setTimeout(() => {
                                                            console.log('üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å–ø–µ–∫—Ç—Ä–∞ –ø–æ—Å–ª–µ PCA');
                                                            createSpectrum();
                                                        }, 1000);
                                                    });
                                                }, 1000);
                                            }
                                        }
                                    }, 1000);
                                }
                            }
                            
                            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≥—Ä–µ–≥–∞—Ü–∏—é –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
                            setTimeout(() => aggregateData(), 500);
                        }
                    } else {
                        statusDiv.innerHTML = `<div class="status success">
                            ‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.files_count} —Ñ–∞–π–ª–æ–≤<br>
                            –ü—Ä–∏–º–µ—Ä—ã: ${data.sample_names ? data.sample_names.slice(0, 5).join(', ') : ''}...
                        </div>`;
                    }
                    document.getElementById('aggregateBtn').disabled = false;
                    
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ PCA –∏ —Å–ø–µ–∫—Ç—Ä–∞, –µ—Å–ª–∏ –ø—Ä–∏–∑–Ω–∞–∫–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω—ã
                    if (selectedFeatures.length > 0) {
                        document.getElementById('evaluateBtn').disabled = false;
                        document.getElementById('pcaBtn').disabled = false;
                        document.getElementById('spectrumBtn').disabled = false;
                    }
                } else {
                    throw new Error(data.detail || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                }
            } catch (error) {
                if (progressInterval) {
                    clearInterval(progressInterval);
                }
                if (showProgress) {
                    progressBar.style.width = '0%';
                    progressBar.textContent = '0%';
                    progressText.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                }
                statusDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
            }
        }
        
        async function aggregateData() {
            if (!currentCacheKey) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ');
                return;
            }
            
            const statusDiv = document.getElementById('aggregateStatus');
            const btn = document.getElementById('aggregateBtn');
            const featuresDiv = document.getElementById('featuresList');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>–ê–≥—Ä–µ–≥–∞—Ü–∏—è...';
            statusDiv.innerHTML = '<div class="status loading">–ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/aggregate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cache_key: currentCacheKey
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentDfFeaturesCacheKey = data.df_features_cache_key;
                    availableFeatures = data.feature_columns;
                    
                    statusDiv.innerHTML = `<div class="status success">
                        ‚úÖ –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–æ ${data.aggregated_rows} –æ–±—Ä–∞–∑—Ü–æ–≤<br>
                        –ù–∞–π–¥–µ–Ω–æ ${data.features_count} –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
                    </div>`;
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
                    featuresDiv.classList.remove('hidden');
                    featuresDiv.innerHTML = `
                        <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏:</h3>
                        <button onclick="downloadCSV('${data.df_features_cache_key}', 'features.csv')" style="margin-bottom: 10px;">üì• –°–∫–∞—á–∞—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–∏ CSV</button>
                        <button onclick="downloadCSV('${data.df_cache_key}', 'aggregated_data.csv')" style="margin-bottom: 10px;">üì• –°–∫–∞—á–∞—Ç—å –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ CSV</button>
                        <div class="feature-list"></div>
                    `;
                    const featureList = featuresDiv.querySelector('.feature-list');
                    
                    availableFeatures.forEach(feature => {
                        const tag = document.createElement('span');
                        tag.className = 'feature-tag';
                        tag.textContent = feature;
                        tag.onclick = () => toggleFeature(feature, tag);
                        featureList.appendChild(tag);
                    });
                    
                    document.getElementById('evaluateBtn').disabled = false;
                    document.getElementById('pcaBtn').disabled = false;
                } else {
                    throw new Error(data.detail || '–û—à–∏–±–∫–∞ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏');
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '–ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å';
            }
        }
        
        function toggleFeature(feature, element) {
            const index = selectedFeatures.indexOf(feature);
            if (index > -1) {
                selectedFeatures.splice(index, 1);
                element.classList.remove('selected');
            } else {
                selectedFeatures.push(feature);
                element.classList.add('selected');
            }
            
            document.getElementById('evaluateBtn').disabled = selectedFeatures.length === 0;
            document.getElementById('pcaBtn').disabled = selectedFeatures.length === 0;
            document.getElementById('spectrumBtn').disabled = selectedFeatures.length === 0;
        }
        
        async function evaluateFeatures() {
            if (!currentDfFeaturesCacheKey || selectedFeatures.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –¥–ª—è –æ—Ü–µ–Ω–∫–∏');
                return;
            }
            
            const statusDiv = document.getElementById('evaluateStatus');
            const btn = document.getElementById('evaluateBtn');
            const resultsDiv = document.getElementById('metricsResults');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>–û—Ü–µ–Ω–∫–∞...';
            statusDiv.innerHTML = '<div class="status loading">–û—Ü–µ–Ω–∫–∞ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/evaluate-features`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        df_features_cache_key: currentDfFeaturesCacheKey,
                        feature_columns: selectedFeatures
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = `<div class="status success">‚úÖ –û—Ü–µ–Ω–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</div>`;
                    
                    resultsDiv.classList.remove('hidden');
                    let html = `<h3>–ú–µ—Ç—Ä–∏–∫–∏:</h3>`;
                    html += `<button onclick="downloadCSV('${currentDfFeaturesCacheKey}', 'features.csv')" style="margin-bottom: 10px;">üì• –°–∫–∞—á–∞—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–∏ CSV</button>`;
                    html += `<div class="metrics-grid">`;
                    html += `<div class="metric-card"><div class="label">Score</div><div class="value">${data.metrics.score.toFixed(4)}</div></div>`;
                    html += `<div class="metric-card"><div class="label">Separation</div><div class="value">${data.metrics.separation.toFixed(4)}</div></div>`;
                    html += `<div class="metric-card"><div class="label">Explained Variance</div><div class="value">${(data.metrics.explained_variance * 100).toFixed(2)}%</div></div>`;
                    html += `<div class="metric-card"><div class="label">Mod Samples</div><div class="value">${data.mod_samples_count}</div></div>`;
                    html += `<div class="metric-card"><div class="label">Normal Samples</div><div class="value">${data.normal_samples_count}</div></div>`;
                    html += `</div>`;
                    html += `<pre>${JSON.stringify(data.metrics, null, 2)}</pre>`;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞
                    window.currentMetrics = data.metrics;
                    
                    resultsDiv.innerHTML = html;
                } else {
                    throw new Error(data.detail || '–û—à–∏–±–∫–∞ –æ—Ü–µ–Ω–∫–∏');
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '–û—Ü–µ–Ω–∏—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–∏';
            }
        }
        
        async function calculatePCAScore() {
            if (!currentDfFeaturesCacheKey || selectedFeatures.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –¥–ª—è PCA');
                return;
            }
            
            const statusDiv = document.getElementById('pcaStatus');
            const btn = document.getElementById('pcaBtn');
            const resultsDiv = document.getElementById('pcaResults');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>–í—ã—á–∏—Å–ª–µ–Ω–∏–µ...';
            statusDiv.innerHTML = '<div class="status loading">–í—ã—á–∏—Å–ª–µ–Ω–∏–µ PCA Score...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/pca-score`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        df_features_cache_key: currentDfFeaturesCacheKey,
                        feature_columns: selectedFeatures,
                        use_relative_features: true
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = `<div class="status success">‚úÖ PCA Score –≤—ã—á–∏—Å–ª–µ–Ω</div>`;
                    
                    resultsDiv.classList.remove('hidden');
                    let html = `<h3>PCA Score —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (${data.samples_count} –æ–±—Ä–∞–∑—Ü–æ–≤):</h3>`;
                    html += `<button onclick="downloadCSV('${currentDfFeaturesCacheKey}', 'pca_scores.csv')" style="margin-bottom: 10px;">üì• –°–∫–∞—á–∞—Ç—å CSV</button>`;
                    html += `<div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: #f9f9f9;">`;
                    html += `<pre style="margin: 0;">${JSON.stringify(data.results.slice(0, 20), null, 2)}${data.results.length > 20 ? '\n... (–ø–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 20)' : ''}</pre>`;
                    html += `</div>`;
                    resultsDiv.innerHTML = html;
                    
                    // –ü–æ—Å–ª–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è PCA –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—á–∏—Å–ª—è–µ–º —Å–ø–µ–∫—Ç—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–∏
                    if (selectedFeatures.length > 0) {
                        console.log('üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å–ø–µ–∫—Ç—Ä–∞ –ø–æ—Å–ª–µ PCA');
                        setTimeout(() => {
                            createSpectrum();
                        }, 500);
                    }
                } else {
                    throw new Error(data.detail || '–û—à–∏–±–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è PCA');
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '–í—ã—á–∏—Å–ª–∏—Ç—å PCA Score';
            }
        }
        
        async function loadExperiments() {
            const statusDiv = document.getElementById('experimentsStatus');
            const btn = document.getElementById('experimentsBtn');
            const listDiv = document.getElementById('experimentsList');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>–ó–∞–≥—Ä—É–∑–∫–∞...';
            statusDiv.innerHTML = '<div class="status loading">–ó–∞–≥—Ä—É–∑–∫–∞ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/experiments?top_n=3`);
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = `<div class="status success">‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.count} —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤</div>`;
                    
                    listDiv.classList.remove('hidden');
                    let html = '<h3>–¢–æ–ø-3 —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞:</h3><div style="display: grid; gap: 10px;">';
                    
                    data.experiments.forEach((exp, idx) => {
                        html += `
                            <div style="border: 2px solid #667eea; padding: 15px; border-radius: 8px; cursor: pointer;" 
                                 onclick="loadExperimentDetails('${exp.name}')">
                                <strong>${idx + 1}. ${exp.name}</strong><br>
                                <small>Score: ${exp.score.toFixed(4)} | Separation: ${exp.separation.toFixed(4)} | Features: ${exp.n_features}</small>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    listDiv.innerHTML = html;
                } else {
                    throw new Error(data.detail || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤');
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–ø-3 —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤';
            }
        }
        
        async function loadExperimentDetails(experimentName) {
            const detailsDiv = document.getElementById('experimentDetails');
            detailsDiv.classList.remove('hidden');
            detailsDiv.innerHTML = '<div class="status loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/load-experiment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        experiment_name: experimentName,
                        experiments_dir: 'experiments'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    let html = `<h3>–î–µ—Ç–∞–ª–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞: ${data.experiment_name}</h3>`;
                    html += `<div class="metrics-grid">`;
                    html += `<div class="metric-card"><div class="label">Score</div><div class="value">${data.metrics.score?.toFixed(4) || 'N/A'}</div></div>`;
                    html += `<div class="metric-card"><div class="label">Separation</div><div class="value">${data.metrics.separation?.toFixed(4) || 'N/A'}</div></div>`;
                    html += `<div class="metric-card"><div class="label">Features</div><div class="value">${data.n_features}</div></div>`;
                    html += `<div class="metric-card"><div class="label">Method</div><div class="value">${data.method}</div></div>`;
                    html += `</div>`;
                    
                    if (data.pca_data && data.pca_data.length > 0) {
                        html += `<h4>PCA –¥–∞–Ω–Ω—ã–µ (${data.pca_samples_count || data.pca_data.length} –æ–±—Ä–∞–∑—Ü–æ–≤):</h4>`;
                        if (data.pca_cache_key) {
                            html += `<button onclick="loadPCADataFromCache('${data.pca_cache_key}')" style="margin-bottom: 10px;">üìä –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª–Ω—ã–µ PCA –¥–∞–Ω–Ω—ã–µ</button>`;
                        }
                        html += `<pre>${JSON.stringify(data.pca_data.slice(0, 10), null, 2)}${(data.pca_samples_count || data.pca_data.length) > 10 ? '\n... (–ø–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 10)' : ''}</pre>`;
                    } else if (data.has_pca && data.pca_cache_key) {
                        html += `<h4>PCA –¥–∞–Ω–Ω—ã–µ:</h4>`;
                        html += `<button onclick="loadPCADataFromCache('${data.pca_cache_key}')" style="margin-bottom: 10px;">üìä –ó–∞–≥—Ä—É–∑–∏—Ç—å PCA –¥–∞–Ω–Ω—ã–µ (${data.pca_samples_count || 0} –æ–±—Ä–∞–∑—Ü–æ–≤)</button>`;
                    }
                    
                    if (data.features && data.features.length > 0) {
                        html += `<h4>–ü—Ä–∏–∑–Ω–∞–∫–∏ (${data.features.length}):</h4><div class="feature-list">`;
                        data.features.forEach(f => {
                            html += `<span class="feature-tag">${f}</span>`;
                        });
                        html += `</div>`;
                    }
                    
                    detailsDiv.innerHTML = html;
                } else {
                    throw new Error(data.detail || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞');
                }
            } catch (error) {
                detailsDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
        
        async function createSpectrum() {
            if (!currentDfFeaturesCacheKey || selectedFeatures.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–ø–µ–∫—Ç—Ä–∞');
                return;
            }
            
            // –ï—Å–ª–∏ PCA –µ—â–µ –Ω–µ –≤—ã—á–∏—Å–ª–µ–Ω, –≤—ã—á–∏—Å–ª—è–µ–º –µ–≥–æ —Å–Ω–∞—á–∞–ª–∞
            const pcaResultsDiv = document.getElementById('pcaResults');
            if (!pcaResultsDiv || pcaResultsDiv.classList.contains('hidden') || pcaResultsDiv.innerHTML.trim() === '') {
                console.log('üîÑ PCA –Ω–µ –≤—ã—á–∏—Å–ª–µ–Ω, –≤—ã—á–∏—Å–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Å–ø–µ–∫—Ç—Ä–∞');
                await calculatePCAScore();
                // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è PCA –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Å–ø–µ–∫—Ç—Ä–∞
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            const statusDiv = document.getElementById('spectrumStatus');
            const btn = document.getElementById('spectrumBtn');
            const resultsDiv = document.getElementById('spectrumResults');
            const percentileLow = parseFloat(document.getElementById('percentileLow').value);
            const percentileHigh = parseFloat(document.getElementById('percentileHigh').value);
            const useGMM = document.getElementById('useGMM').checked;
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>–°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–µ–∫—Ç—Ä–∞...';
            statusDiv.innerHTML = '<div class="status loading">–°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–µ–∫—Ç—Ä–∞...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/create-spectrum`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        df_features_cache_key: currentDfFeaturesCacheKey,
                        feature_columns: selectedFeatures,
                        percentile_low: percentileLow,
                        percentile_high: percentileHigh,
                        use_relative_features: true,
                        use_gmm_classification: useGMM
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = `<div class="status success">‚úÖ –°–ø–µ–∫—Ç—Ä —Å–æ–∑–¥–∞–Ω</div>`;
                    
                    resultsDiv.classList.remove('hidden');
                    let html = `<h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–ø–µ–∫—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:</h3>`;
                    
                    if (data.spectrum_data && data.spectrum_data.length > 0) {
                        html += `<button onclick="downloadCSV('${data.spectrum_cache_key}', 'spectrum_data.csv')" style="margin-bottom: 10px;">üì• –°–∫–∞—á–∞—Ç—å —Å–ø–µ–∫—Ç—Ä CSV</button>`;
                    }
                    
                    if (data.modes && data.modes.length > 0) {
                        html += `<h4>–ú–æ–¥—ã (${data.modes.length}):</h4><pre>${JSON.stringify(data.modes, null, 2)}</pre>`;
                    }
                    
                    if (data.percentiles) {
                        html += `<h4>–ü—Ä–æ—Ü–µ–Ω—Ç–∏–ª–∏:</h4><pre>${JSON.stringify(data.percentiles, null, 2)}</pre>`;
                    }
                    
                    if (data.spectrum_data && data.spectrum_data.length > 0) {
                        html += `<h4>–°–ø–µ–∫—Ç—Ä–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø–µ—Ä–≤—ã–µ 10):</h4><pre>${JSON.stringify(data.spectrum_data.slice(0, 10), null, 2)}</pre>`;
                    }
                    
                    if (data.gmm) {
                        html += `<h4>GMM –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:</h4><pre>${JSON.stringify(data.gmm, null, 2)}</pre>`;
                    }
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞
                    if (data.spectrum_cache_key) {
                        window.currentSpectrumCacheKey = data.spectrum_cache_key;
                    }
                    if (data.analyzer_cache_key) {
                        window.currentAnalyzerCacheKey = data.analyzer_cache_key;
                    }
                    
                    resultsDiv.innerHTML = html;
                    
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞
                    document.getElementById('saveExperimentBtn').disabled = false;
                } else {
                    throw new Error(data.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ø–µ–∫—Ç—Ä–∞');
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '–°–æ–∑–¥–∞—Ç—å —Å–ø–µ–∫—Ç—Ä';
            }
        }
        
        function downloadCSV(cacheKey, filename) {
            const url = `${API_BASE}/api/v1/download-csv?cache_key=${encodeURIComponent(cacheKey)}&filename=${encodeURIComponent(filename)}`;
            window.open(url, '_blank');
        }
        
        async function loadPCADataFromCache(pcaCacheKey) {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º PCA –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞ —á–µ—Ä–µ–∑ download-csv endpoint
                const response = await fetch(`${API_BASE}/api/v1/download-csv?cache_key=${encodeURIComponent(pcaCacheKey)}&filename=pca_results.csv`);
                if (response.ok) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º PCA —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    const pcaResultsDiv = document.getElementById('pcaResults');
                    if (pcaResultsDiv) {
                        pcaResultsDiv.classList.remove('hidden');
                        
                        // –ü–∞—Ä—Å–∏–º CSV –¥–∞–Ω–Ω—ã–µ
                        const csvText = await response.text();
                        const lines = csvText.split('\n').filter(line => line.trim());
                        if (lines.length > 1) {
                            // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ CSV —Å —É—á–µ—Ç–æ–º –∫–∞–≤—ã—á–µ–∫
                            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                            const data = lines.slice(1, 21).map(line => {
                                // –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ CSV (–º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ —Å –∑–∞–ø—è—Ç—ã–º–∏ –≤ –∑–Ω–∞—á–µ–Ω–∏—è—Ö)
                                const values = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                                const obj = {};
                                headers.forEach((header, idx) => {
                                    obj[header] = values[idx] || '';
                                });
                                return obj;
                            });
                            
                            let html = `<h3>üìä PCA –¥–∞–Ω–Ω—ã–µ –∏–∑ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ (${lines.length - 1} –æ–±—Ä–∞–∑—Ü–æ–≤):</h3>`;
                            html += `<button onclick="downloadCSV('${pcaCacheKey}', 'pca_results.csv')" style="margin-bottom: 10px;">üì• –°–∫–∞—á–∞—Ç—å CSV</button>`;
                            html += `<div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: #f9f9f9;">`;
                            html += `<pre style="margin: 0;">${JSON.stringify(data, null, 2)}${lines.length > 21 ? '\n... (–ø–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 20)' : ''}</pre>`;
                            html += `</div>`;
                            pcaResultsDiv.innerHTML = html;
                            
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                            window.currentPCACacheKey = pcaCacheKey;
                            
                            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É PCA Score, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
                            const pcaBtn = document.getElementById('pcaBtn');
                            if (pcaBtn) {
                                pcaBtn.disabled = false;
                            }
                        } else {
                            pcaResultsDiv.innerHTML = `<h3>PCA –¥–∞–Ω–Ω—ã–µ –∏–∑ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞:</h3><p>‚úÖ PCA –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–í—ã—á–∏—Å–ª–∏—Ç—å PCA Score" –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</p>`;
                        }
                    }
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å PCA –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞:', pcaCacheKey, errorText);
                    const pcaResultsDiv = document.getElementById('pcaResults');
                    if (pcaResultsDiv) {
                        pcaResultsDiv.classList.remove('hidden');
                        pcaResultsDiv.innerHTML = `<div class="status error">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å PCA –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞: ${pcaCacheKey}<br>–û—à–∏–±–∫–∞: ${errorText}</div>`;
                    }
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ PCA –¥–∞–Ω–Ω—ã—Ö:', error);
                const pcaResultsDiv = document.getElementById('pcaResults');
                if (pcaResultsDiv) {
                    pcaResultsDiv.classList.remove('hidden');
                    pcaResultsDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ PCA –¥–∞–Ω–Ω—ã—Ö: ${error.message}</div>`;
                }
            }
        }
        
        async function saveExperiment() {
            if (!currentDfFeaturesCacheKey || selectedFeatures.length === 0) {
                alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –∏ –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–∏');
                return;
            }
            
            const experimentName = document.getElementById('experimentName').value || `experiment_${new Date().toISOString().slice(0, 10)}`;
            const statusDiv = document.getElementById('saveExperimentStatus');
            const btn = document.getElementById('saveExperimentBtn');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            statusDiv.innerHTML = '<div class="status loading">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞...</div>';
            
            try {
                const requestBody = {
                    experiment_name: experimentName,
                    df_features_cache_key: currentDfFeaturesCacheKey,
                    feature_columns: selectedFeatures,
                    metrics: window.currentMetrics || null,
                    use_relative_features: true,
                    method: 'api_manual',
                    experiments_dir: 'experiments'
                };
                
                const response = await fetch(`${API_BASE}/api/v1/save-experiment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = `<div class="status success">‚úÖ –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: ${data.experiment_path}</div>`;
                    
                    let filesHtml = '<h4>–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:</h4><ul>';
                    for (const [key, value] of Object.entries(data.files_saved)) {
                        if (value) {
                            filesHtml += `<li>${key}: ${value}</li>`;
                        }
                    }
                    filesHtml += '</ul>';
                    statusDiv.innerHTML += filesHtml;
                } else {
                    throw new Error(data.detail || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞');
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç';
            }
        }
    </script>
</body>
</html>

